<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f0e6">
    <title>Rhapsode</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <style>
        /* Disable double-tap zoom globally on mobile */
        *, *::before, *::after { touch-action: manipulation; }
        :root {
            --bg-primary: #f5f0e6; --bg-secondary: #ebe5d9; --bg-card: #faf7f0;
            /* ORIGINAL BROWNS: --text-secondary: #5c4d3a; --text-muted: #8a7a62; --border: #d4c9b5; */
            --text-primary: #2c2416; --text-secondary: #5a4530; --text-muted: #8a7055;
            /* Safe area insets for mobile */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            /* ORIGINAL COLORS: --accent: #b8956e; --accent-hover: #a07d54; --success: #6b8e5c; --warning: #c4944a; --high: #c4944a; --medium: #8a9a7a; --low: #9a8a7a; */
            --accent: #c4622e; --accent-hover: #b05628; --border: #d4bfa8;
            --success: #7a8a4a; --warning: #d4762a; --shadow: rgba(44, 36, 22, 0.1);
            --high: #d4642a; --medium: #9a8a50; --low: #a89060;
            --paper-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }
        [data-theme="dark"] {
            --bg-primary: #1a1612; --bg-secondary: #252019; --bg-card: #2a241c;
            --text-primary: #e8e0d4; --text-secondary: #c4b098; --text-muted: #8a7055;
            --accent: #d0703a; --accent-hover: #dc804a; --border: #3d3228; --shadow: rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; background-color: var(--bg-primary); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); min-height: 100vh; transition: background-color 0.3s, color 0.3s; overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom, 24px); }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        header { text-align: center; padding: 15px 0 30px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        body.platform-mobile .theme-toggle { top: 66px; }
        h1 { font-family: Georgia, 'Times New Roman', serif; font-size: 2.5rem; font-weight: normal; letter-spacing: 0.1em; color: var(--text-primary); margin-bottom: 5px; }
        .subtitle { font-style: italic; color: var(--text-muted); font-size: 0.9rem; }
        .theme-toggle { position: absolute; top: 43px; right: 35px; background: none; border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; color: var(--text-secondary); transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .theme-toggle:hover { border-color: var(--accent); color: var(--accent); }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; padding: 12px 24px; font-size: 1rem; color: var(--text-muted); cursor: pointer; position: relative; transition: color 0.3s; }
        .tab-btn::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: var(--accent); transition: width 0.3s; }
        .tab-btn:hover { color: var(--text-secondary); }
        .tab-btn.active { color: var(--text-primary); }
        .tab-btn.active::after { width: 100%; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Collections */
        .section-title { font-family: Georgia, serif; font-size: 1.2rem; font-weight: normal; margin: 25px 0 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .section-title .count { font-size: 0.85rem; color: var(--text-muted); font-family: sans-serif; }
        .collections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 25px; }
        .collection-card { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border); border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; }
        .collection-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--shadow); border-color: var(--accent); }
        .collection-card.active { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; }
        .collection-card h4 { font-family: Georgia, serif; font-weight: normal; font-size: 1rem; margin-bottom: 4px; }
        .collection-card .coll-count { font-size: 0.75rem; opacity: 0.7; }

        /* Theme Tags */
        .theme-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .theme-tag { padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); }
        .theme-tag:hover { border-color: var(--accent); color: var(--accent); }
        .theme-tag.active { background: var(--accent); color: white; border-color: var(--accent); }
        .theme-tag .tag-count { opacity: 0.7; margin-left: 4px; }

        /* Search and Filters */
        .search-container { margin-bottom: 15px; }
        .search-input { width: 100%; padding: 14px 20px; font-size: 1rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-card); color: var(--text-primary); }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(184, 149, 110, 0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-select { padding: 10px 15px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; background-color: var(--bg-card); color: var(--text-primary); cursor: pointer; min-width: 130px; }
        .filter-select:focus { outline: none; border-color: var(--accent); }
        .clear-filters { padding: 10px 15px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px; background: none; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .clear-filters:hover { border-color: var(--accent); color: var(--accent); }
        .library-stats { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px; }

        /* Poem Cards */
        .poem-grid { display: grid; gap: 20px; }
        .poem-card { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .poem-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--shadow); }
        .poem-card h3 { font-family: Georgia, 'Times New Roman', serif; font-size: 1.2rem; font-weight: normal; margin-bottom: 6px; color: var(--text-primary); padding-right: 60px; }
        .poem-card .author { font-style: italic; color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9rem; }
        .poem-card .preview { color: var(--text-muted); font-family: Georgia, serif; font-size: 0.85rem; line-height: 1.5; }
        .poem-card .meta { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; align-items: center; }
        .poem-card .line-count { font-size: 0.75rem; color: var(--text-muted); }
        .poem-card .era-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: var(--bg-secondary); color: var(--text-muted); }
        .poem-card .poem-themes { display: flex; gap: 4px; flex-wrap: wrap; }
        .poem-card .poem-theme { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; background: var(--bg-secondary); color: var(--text-muted); }
        .popularity-badge { position: absolute; top: 15px; right: 15px; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; text-transform: uppercase; }
        .popularity-badge.high { background-color: var(--high); color: white; }
        .popularity-badge.medium { background-color: var(--medium); color: white; }
        .popularity-badge.low { background-color: var(--low); color: white; }
        .poem-card .progress-bar-container { margin-top: 15px; background-color: var(--bg-secondary); border-radius: 10px; height: 6px; overflow: hidden; }
        .poem-card .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 10px; transition: width 0.5s ease; }
        .poem-card .stage-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; }
        .poem-card .card-actions { display: flex; gap: 10px; margin-top: 15px; }
        .badge { position: absolute; top: 15px; right: 15px; background-color: var(--warning); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; min-height: 44px; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .btn-text { background: none; border: none; color: var(--accent); text-decoration: underline; text-underline-offset: 2px; padding: 8px 12px; }
        .btn-text:hover { color: var(--accent-hover); text-decoration-thickness: 2px; }
        .btn-small { padding: 6px 14px; font-size: 0.85rem; }
        .load-more { width: 100%; margin-top: 20px; padding: 15px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background-color: var(--bg-card); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s ease; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-secondary); }
        .modal::-webkit-scrollbar { width: 8px; }
        .modal::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .modal::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 24px 30px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-header h2 { font-family: Georgia, serif; font-weight: normal; font-size: 1.5rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0; line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 15px 30px 30px; }
        .modal-author { font-style: italic; color: var(--text-secondary); margin-bottom: 10px; }
        .modal-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .modal-meta span { font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; background: var(--bg-secondary); color: var(--text-muted); }
        .poem-text { font-family: Georgia, serif; line-height: 1.8; white-space: pre-wrap; color: var(--text-primary); }
        .poem-text .stanza { margin-bottom: 1.5em; }
        .poem-text .section-number, .stanza .section-number { font-size: 1.2rem; font-weight: normal; color: var(--accent); margin-bottom: 0.5em; text-align: center; white-space: normal; }
        .modal-actions { padding: 0 30px 24px; display: flex; gap: 10px; justify-content: flex-end; }

        /* Add Poem Section */
        .add-poem-section { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 25px; }
        .add-poem-section h3 { font-family: Georgia, serif; font-weight: normal; font-size: 1.2rem; margin-bottom: 20px; }
        .add-poem-section.collapsed .add-poem-form { display: none; }
        .add-poem-section.collapsed h3 { margin-bottom: 0; }
        .section-toggle { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-toggle .toggle-icon { font-size: 1.5rem; color: var(--text-muted); transition: transform 0.3s; }
        .add-poem-section.collapsed .toggle-icon { transform: rotate(0deg); }
        .add-poem-section:not(.collapsed) .toggle-icon { transform: rotate(45deg); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 16px; font-size: 1rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-secondary); color: var(--text-primary); }
        .form-group textarea { min-height: 200px; font-family: Georgia, serif; line-height: 1.6; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 8px; padding: 8px; background-color: var(--bg-secondary); border: 1px solid var(--border); border-bottom: none; border-radius: 8px 8px 0 0; }
        .toolbar-btn { background: none; border: 1px solid transparent; padding: 6px 10px; cursor: pointer; color: var(--text-secondary); border-radius: 4px; font-size: 0.9rem; }
        .toolbar-btn:hover { background-color: var(--bg-card); border-color: var(--border); }
        .editor-container textarea { border-radius: 0 0 8px 8px; }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
        .stat-card .stat-value { font-family: Georgia, serif; font-size: 2.5rem; color: var(--accent); margin-bottom: 5px; }
        .stat-card .stat-label { font-size: 0.85rem; color: var(--text-muted); }

        /* Learning */
        .learning-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); z-index: 200; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-secondary); touch-action: manipulation; -ms-touch-action: manipulation; }
        .learning-container button, .learning-container .btn, .learning-footer button { touch-action: manipulation; }
        .learning-container::-webkit-scrollbar { width: 8px; }
        .learning-container::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .learning-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .learning-container::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .learning-container.active { display: block; }
        .learning-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; background-color: var(--bg-secondary); min-height: 80px; }
        .learning-header-left { justify-self: start; }
        .learning-header-center { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .learning-header-title-row { display: flex; align-items: center; gap: 12px; }
        .stage-skip-btn { background: none; border: 1px solid var(--border); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .stage-skip-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .stage-skip-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .learning-title { font-family: Georgia, serif; font-size: 1.2rem; text-align: center; }
        .learning-stage { font-size: 0.9rem; color: var(--text-muted); text-align: center; }
        .learning-body { max-width: 700px; margin: 0 auto; padding: 40px 20px 120px; }
        .learning-poem-title { font-family: Georgia, serif; font-size: 1.8rem; text-align: center; margin-bottom: 30px; }
        .learning-line { font-family: Georgia, serif; font-size: 1.3rem; line-height: 2; margin-bottom: 10px; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; opacity: 0; transform: translateX(-20px); user-select: none; -webkit-user-select: none; }
        .learning-line.visible { opacity: 1; transform: translateX(0); transition: opacity 0.5s ease, transform 0.5s ease; }
        .learning-line:hover { background-color: var(--bg-secondary); }
        .learning-line.revealed { background-color: var(--bg-secondary); }
        .learning-line .blank { display: inline-block; border-bottom: 2px solid var(--accent); margin: 0 4px; text-align: center; min-width: 20px; }
        .learning-line .blank.revealed { border-bottom-color: var(--success); color: var(--text-primary); }
        .learning-stanza { margin-bottom: 2em; }
        .learning-prompt { text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; margin-top: 20px; }
        .learning-footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background-color: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; z-index: 210; }
        .dot-line { display: flex; flex-wrap: wrap; gap: 6px; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; min-height: 44px; align-items: center; user-select: none; -webkit-user-select: none; }
        .dot-line:hover { background-color: var(--bg-secondary); }
        .dot-line.revealed { background-color: var(--bg-secondary); }
        .word-dot { width: 10px; height: 10px; background-color: var(--text-muted); border-radius: 50%; }
        .dot-line .hint-text, .dot-line .full-line { font-family: Georgia, serif; font-size: 1.2rem; color: var(--text-primary); }
        .hint-instructions { text-align: center; padding: 10px; background-color: var(--bg-secondary); border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted); }
        .practice-summary { text-align: center; padding: 30px; }
        .practice-summary h3 { font-family: Georgia, serif; font-weight: normal; margin-bottom: 15px; }

        /* Recitation Complete UI */
        .recitation-complete { text-align: center; padding: 40px 20px; }
        .recitation-complete h3 { font-family: Georgia, serif; font-weight: normal; font-size: 1.4rem; margin-bottom: 10px; }
        .recitation-progress { color: var(--text-muted); margin-bottom: 25px; font-size: 1rem; }
        .recitation-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-success:hover { background: #5a7d4b; }
        .btn-warning { background: var(--warning); color: white; border: none; }
        .btn-warning:hover { background: #b3833a; }

        
        /* Stage Picker */
        .stage-picker { text-align: center; padding: 40px 20px; }
        .stage-picker h3 { font-family: Georgia, serif; font-weight: normal; font-size: 1.3rem; margin-bottom: 8px; }
        .stage-picker p { color: var(--text-muted); margin-bottom: 25px; }
        .stage-options { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: 0 auto; }
        .stage-option-btn { padding: 12px 20px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); cursor: pointer; transition: all 0.2s; text-align: left; }
        .stage-option-btn:hover { border-color: var(--accent); background: var(--bg-secondary); }
        .stage-option-btn .stage-num { font-weight: 500; color: var(--accent); }

        
        /* States */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state h3 { font-family: Georgia, serif; font-weight: normal; font-size: 1.3rem; margin-bottom: 10px; color: var(--text-secondary); }
        .loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; color: var(--text-muted); font-style: italic; }
        .error-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .error-state h3 { font-family: Georgia, serif; font-weight: normal; margin-bottom: 10px; }
        .error-state p { color: var(--text-muted); margin-bottom: 20px; }

        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .tabs { flex-wrap: wrap; }
            .tab-btn { padding: 10px 16px; font-size: 0.9rem; }
            .theme-toggle { top: 44px; right: 28px; }
            .modal { margin: 10px; }
            .learning-line { font-size: 1.1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
            .collections-grid { grid-template-columns: repeat(2, 1fr); }
            .filter-row { flex-direction: column; }
            .filter-select { width: 100%; }
            .auth-btn { padding: 6px 10px; font-size: 0.75rem; }
            .learning-header { padding: 12px 15px; min-height: 70px; }
            .learning-header-title-row { gap: 8px; }
            .learning-title { font-size: 1rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .learning-stage { font-size: 0.8rem; }
            .stage-skip-btn { width: 28px; height: 28px; font-size: 0.9rem; }
            .recitation-buttons { flex-direction: column; gap: 12px; }
            .recitation-buttons .btn { width: 100%; }
            .home-card { flex: 0 0 240px; }
            .home-hero-actions { flex-wrap: nowrap; }
            .home-hero-actions .btn { flex: 1; padding: 10px 10px; font-size: 0.82rem; text-align: center; }
        }

        /* Auth Styles */
        .auth-buttons { display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 15px; }
        .auth-btn { height: 40px; min-width: 80px; padding: 0 16px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .auth-btn-secondary { background: none; border: 1px solid var(--border); color: var(--text-secondary); }
        .auth-btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .auth-btn-primary { background-color: var(--accent); border: 1px solid var(--accent); color: white; }
        .auth-btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .auth-user { display: flex; align-items: center; gap: 10px; }
        .auth-user-email { font-size: 0.85rem; color: var(--text-secondary); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .auth-modal { max-width: 400px; position: relative; }
        .auth-modal .modal-header { text-align: center; padding: 20px 30px 15px; display: block; }
        .auth-modal .modal-header h2 { font-size: 1.8rem; margin: 0 auto; }
        .auth-modal .modal-close { position: absolute; top: 15px; right: 20px; }
        .auth-modal .modal-body { padding: 10px 30px 30px; }
        .auth-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.3s; background: none; border-top: none; border-left: none; border-right: none; font-size: 0.95rem; }
        .auth-tab:hover { color: var(--text-secondary); }
        .auth-tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-form .form-group { margin-bottom: 16px; }
        .auth-form .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; }
        .auth-form .form-group input { width: 100%; padding: 12px 14px; font-size: 0.95rem; border: 1px solid var(--border); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        .auth-form .form-group input:focus { outline: none; border-color: var(--accent); }
        .auth-form .btn { width: 100%; margin-top: 10px; }
        .auth-error { background-color: rgba(200, 80, 80, 0.1); border: 1px solid rgba(200, 80, 80, 0.3); color: #c85050; padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; font-size: 0.85rem; display: none; }
        .auth-error.visible { display: block; }
        .auth-success { background-color: rgba(107, 142, 92, 0.1); border: 1px solid rgba(107, 142, 92, 0.3); color: var(--success); padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; font-size: 0.85rem; display: none; }
        .auth-success.visible { display: block; }
        .auth-link { color: var(--accent); cursor: pointer; font-size: 0.85rem; }
        .auth-link:hover { text-decoration: underline; }
        .auth-divider { text-align: center; color: var(--text-muted); font-size: 0.85rem; margin: 15px 0; }
        .sync-notice { background-color: var(--bg-secondary); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.85rem; color: var(--text-secondary); }
        .sync-notice strong { color: var(--text-primary); }
        .account-link { color: var(--text-muted); font-size: 0.75rem; cursor: pointer; margin-left: 10px; }
        .account-link:hover { color: var(--accent); text-decoration: underline; }
        .account-link.danger:hover { color: #c85050; }
        .btn-danger { background-color: #c85050; border: 1px solid #c85050; color: white; }
        .btn-danger:hover { background-color: #b04040; border-color: #b04040; }
        .delete-modal { max-width: 450px; }
        .delete-modal .modal-body { padding: 20px 30px 30px; }
        .delete-warning { background-color: rgba(200, 80, 80, 0.1); border: 1px solid rgba(200, 80, 80, 0.3); color: #c85050; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
        .delete-confirm-input { width: 100%; padding: 12px 14px; font-size: 0.95rem; border: 1px solid var(--border); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); margin: 15px 0; }
        .delete-confirm-input:focus { outline: none; border-color: #c85050; }
        .delete-modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }

        /* Legal Pages */
        #privacy-modal, #terms-modal, #support-modal { z-index: 150; }
        .legal-modal { max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; }
        .legal-modal .modal-body { overflow-y: auto; padding: 20px 30px 30px; flex: 1; }
        .legal-content { font-size: 0.95rem; line-height: 1.7; color: var(--text-secondary); }
        .legal-content h2 { font-family: Georgia, serif; font-size: 1.5rem; color: var(--text-primary); margin: 0 0 10px 0; font-weight: normal; }
        .legal-content h3 { font-family: Georgia, serif; font-size: 1.1rem; color: var(--text-primary); margin: 25px 0 10px 0; font-weight: normal; }
        .legal-content p { margin: 0 0 15px 0; }
        .legal-content ul { margin: 0 0 15px 0; padding-left: 20px; }
        .legal-content li { margin-bottom: 8px; }
        .legal-content .last-updated { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; }
        .terms-checkbox { display: flex; align-items: flex-start; gap: 10px; margin: 15px 0; font-size: 0.85rem; color: var(--text-secondary); }
        .terms-checkbox input[type="checkbox"] { margin-top: 3px; width: 16px; height: 16px; cursor: pointer; }
        .terms-checkbox label { cursor: pointer; line-height: 1.4; }
        .terms-checkbox a { color: var(--accent); text-decoration: none; }
        .terms-checkbox a:hover { text-decoration: underline; }

        /* Footer */
        .app-footer { text-align: center; padding: 30px 20px; margin-top: 40px; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.85rem; }
        .app-footer a { color: var(--text-muted); text-decoration: none; margin: 0 15px; }
        .app-footer a:hover { color: var(--accent); text-decoration: underline; }

        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .achievement-card { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; transition: all 0.3s; }
        .achievement-card.earned { border-color: var(--warning); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(196, 148, 74, 0.1) 100%); }
        .achievement-card.locked { opacity: 0.6; }
        .achievement-name { font-family: Georgia, serif; font-size: 1.1rem; margin-bottom: 4px; color: var(--text-primary); }
        .achievement-card.earned .achievement-name { color: var(--warning); }
        .achievement-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; }
        .achievement-phrase { font-size: 0.8rem; font-style: italic; color: var(--text-secondary); margin-bottom: 8px; }
        .achievement-status { font-size: 0.75rem; color: var(--text-muted); }
        .achievement-card.earned .achievement-status { color: var(--success); }

        /* Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background-color: var(--bg-card); border: 1px solid var(--warning); border-radius: 10px; padding: 16px 24px; box-shadow: 0 8px 30px var(--shadow); z-index: 1000; opacity: 0; transition: all 0.4s ease; text-align: center; }
        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-title { font-family: Georgia, serif; font-size: 1rem; color: var(--warning); margin-bottom: 4px; }
        .toast-message { font-size: 0.9rem; color: var(--text-primary); }

        /* Home Tab */
        .home-hero { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border); border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px var(--shadow); }
        .home-hero-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 10px; font-weight: 500; }
        .home-hero-title { font-family: Georgia, serif; font-size: 1.8rem; font-weight: normal; margin-bottom: 6px; color: var(--text-primary); }
        .home-hero-author { font-style: italic; color: var(--text-secondary); margin-bottom: 20px; font-size: 1rem; }
        .home-hero-preview { font-family: Georgia, serif; color: var(--text-muted); line-height: 1.8; margin-bottom: 25px; font-size: 1rem; white-space: pre-line; padding: 20px; background-color: var(--bg-primary); border-radius: 10px; border-left: 3px solid var(--accent); }
        .home-hero-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .home-section { margin-bottom: 35px; position: relative; }
        .home-section-title { font-family: Georgia, serif; font-size: 1.2rem; font-weight: normal; color: var(--text-primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .home-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .home-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 6px 0 10px 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .home-scroll::-webkit-scrollbar { height: 6px; }
        .home-scroll::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        .home-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .home-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .home-card { flex: 0 0 280px; scroll-snap-align: start; background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.3s; }
        .home-card:last-child { margin-right: 20px; }
        .home-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow); border-color: var(--accent); }
        .home-card-title { font-family: Georgia, serif; font-size: 1.05rem; font-weight: normal; margin-bottom: 4px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .home-card-author { font-style: italic; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px; }
        .home-card-stat { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .home-card-stat svg { width: 14px; height: 14px; }
        .home-welcome { text-align: center; padding: 20px 0 30px; }
        .home-welcome-text { font-family: Georgia, serif; font-size: 1.1rem; color: var(--text-secondary); font-style: italic; }

        /* Admin Panel */
        .admin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); z-index: 300; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-secondary); }
        .admin-overlay::-webkit-scrollbar { width: 8px; }
        .admin-overlay::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .admin-overlay::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .admin-overlay::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .admin-overlay.active { display: block; }
        .admin-container { max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .admin-header h1 { font-family: Georgia, serif; font-size: 1.8rem; font-weight: normal; }
        .admin-login { max-width: 400px; margin: 100px auto; padding: 30px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .admin-login h2 { font-family: Georgia, serif; font-weight: normal; margin-bottom: 20px; text-align: center; }
        .admin-login .form-group { margin-bottom: 20px; }
        .admin-login input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .admin-login .btn { width: 100%; }
        .admin-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .admin-section h2 { font-family: Georgia, serif; font-weight: normal; font-size: 1.3rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .admin-poem-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .admin-poem-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; }
        .admin-poem-item .poem-info { flex: 1; }
        .admin-poem-item .poem-title { font-weight: 500; margin-bottom: 2px; }
        .admin-poem-item .poem-author { font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
        .admin-poem-item .poem-note { margin-top: 4px; }
        .admin-poem-item .poem-note input { padding: 6px 10px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); width: 200px; }
        .admin-poem-item .order-btns { display: flex; gap: 4px; }
        .admin-poem-item .order-btn { padding: 4px 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .admin-poem-item .order-btn:hover { border-color: var(--accent); color: var(--accent); }
        .admin-poem-item .remove-btn { padding: 6px 12px; border: 1px solid rgba(200,80,80,0.3); background: rgba(200,80,80,0.1); color: #c85050; cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .admin-poem-item .remove-btn:hover { background: rgba(200,80,80,0.2); }
        .admin-search { margin-bottom: 15px; }
        .admin-search input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); }
        .admin-results { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
        .admin-results .result-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .admin-results .result-item:last-child { border-bottom: none; }
        .admin-results .result-item:hover { background: var(--bg-secondary); }
        .admin-results .result-item.added { opacity: 0.5; }
        .admin-results .add-btn { padding: 4px 12px; border: 1px solid var(--accent); background: transparent; color: var(--accent); cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .admin-results .add-btn:hover { background: var(--accent); color: white; }
        .admin-actions { display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        .admin-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .admin-row .form-group { margin-bottom: 0; }
        .admin-row label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem; }
        .admin-row input, .admin-row select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); }
        .admin-current { padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 15px; }
        .admin-current-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .admin-current-value { font-family: Georgia, serif; }
        .admin-empty { color: var(--text-muted); font-style: italic; padding: 20px; text-align: center; }
        .admin-saved { color: var(--success); font-size: 0.9rem; margin-left: 10px; }

        /* Admin Poem Management */
        .admin-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .admin-tab { padding: 12px 20px; cursor: pointer; color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.3s; background: none; border-top: none; border-left: none; border-right: none; font-size: 0.95rem; }
        .admin-tab:hover { color: var(--text-secondary); }
        .admin-tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .admin-poem-table { width: 100%; border-collapse: collapse; }
        .admin-poem-table th, .admin-poem-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .admin-poem-table th { font-weight: 500; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; }
        .admin-poem-table tr:hover { background: var(--bg-secondary); }
        .admin-poem-table .actions { white-space: nowrap; }
        .admin-poem-table .actions button { padding: 4px 10px; margin-right: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .admin-poem-table .actions button:hover { border-color: var(--accent); color: var(--accent); }
        .admin-poem-table .actions .delete-btn { border-color: rgba(200,80,80,0.3); color: #c85050; }
        .admin-poem-table .actions .delete-btn:hover { background: rgba(200,80,80,0.1); }
        .admin-form { max-width: 700px; }
        .admin-form .form-group { margin-bottom: 20px; }
        .admin-form label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .admin-form textarea { min-height: 300px; font-family: Georgia, serif; line-height: 1.6; }
        .admin-form .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .admin-form .checkbox-item { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .admin-form .checkbox-item input { width: auto; }
        .admin-form .checkbox-item.checked { background: var(--accent); color: white; }
        .admin-preview { margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 8px; }
        .admin-preview h4 { font-family: Georgia, serif; margin-bottom: 10px; }
        .admin-preview .stanza { margin-bottom: 1em; font-family: Georgia, serif; line-height: 1.7; }
        .admin-bulk-textarea { min-height: 400px; font-family: monospace; font-size: 0.9rem; }
        .admin-bulk-preview { margin-top: 20px; }
        .admin-bulk-item { padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 10px; }
        .admin-bulk-item h4 { font-family: Georgia, serif; margin-bottom: 4px; }
        .admin-bulk-item p { color: var(--text-muted); font-size: 0.85rem; }
        .admin-pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .admin-pagination button { padding: 8px 14px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; border-radius: 4px; }
        .admin-pagination button:hover { border-color: var(--accent); color: var(--accent); }
        .admin-pagination button.active { background: var(--accent); color: white; border-color: var(--accent); }
        .admin-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .admin-count { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; }

        /* Reader Overlay */
        .reader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); z-index: 200; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-secondary); }
        .reader-container::-webkit-scrollbar { width: 8px; }
        .reader-container::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .reader-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .reader-container::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .reader-container.active { display: block; }
        .reader-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); position: sticky; top: 0; z-index: 10; }
        .reader-header-left { display: flex; align-items: center; gap: 15px; }
        .reader-title { font-family: Georgia, serif; font-size: 1.2rem; }
        .reader-body { max-width: 650px; margin: 0 auto; padding: 50px 30px 100px; }
        .reader-poem-title { font-family: Georgia, serif; font-size: 2rem; text-align: center; margin-bottom: 8px; font-weight: normal; }
        .reader-poem-author { font-style: italic; color: var(--text-secondary); text-align: center; margin-bottom: 40px; font-size: 1.1rem; }
        .reader-poem-text { font-family: Georgia, serif; font-size: 1.25rem; line-height: 2; }
        .reader-poem-text .stanza { margin-bottom: 2em; }
        .reader-poem-text .section-number { font-size: 1.5rem; font-weight: normal; color: var(--accent); margin-bottom: 0.5em; text-align: center; }
        .reader-poem-text .poem-line { padding: 4px 8px; margin: 2px -8px; border-radius: 4px; cursor: text; transition: background-color 0.2s; width: fit-content; }
        .reader-poem-text .poem-line:hover { background-color: var(--bg-secondary); }
        .reader-poem-text .poem-line.highlighted { background-color: rgba(196, 148, 74, 0.25); }
        .reader-poem-text .poem-line.selecting { background-color: rgba(184, 149, 110, 0.15); }
        /* Quote Selection Popup */
        /* Quote Selection Popup */
        .quote-popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 299; display: none; }
        .quote-popup-overlay.visible { display: block; }
        [data-theme="dark"] .quote-popup-overlay { background: rgba(0,0,0,0.7); }
        .quote-popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px var(--shadow); z-index: 300; display: none; width: 90%; max-width: 400px; max-height: 80vh; }
        .quote-popup.visible { display: block; }
        .quote-popup-text { font-family: Georgia, serif; font-size: 1.1rem; line-height: 1.8; color: var(--text-primary); padding: 20px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--accent); margin-bottom: 20px; max-height: 40vh; overflow-y: auto; white-space: pre-wrap; font-style: italic; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-secondary); }
        .quote-popup-text::-webkit-scrollbar { width: 8px; }
        .quote-popup-text::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .quote-popup-text::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .quote-popup-text::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .quote-popup-buttons { display: flex; gap: 12px; }
        .quote-popup-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; border-radius: 10px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); }
        .quote-popup-btn:hover { background: var(--bg-primary); border-color: var(--accent); }
        .quote-popup-btn.primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; border: none; box-shadow: 0 2px 8px rgba(184, 149, 110, 0.3); }
        .quote-popup-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(184, 149, 110, 0.4); }
        .reader-footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background-color: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; }

        /* Quotes Section */
        .quotes-grid { display: grid; gap: 18px; }
        .quote-card { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .quote-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--shadow); }
        .quote-text {
            font-family: Georgia, serif;
            font-size: 1.15rem;
            line-height: 1.9;
            color: var(--text-primary);
            margin-bottom: 18px;
            padding: 28px 20px 16px 20px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            white-space: pre-wrap;
            font-style: italic;
            position: relative;
        }
        .quote-text::before {
            content: '"';
            font-family: Georgia, serif;
            font-size: 3rem;
            color: var(--accent);
            opacity: 0.3;
            position: absolute;
            top: 5px;
            left: 10px;
            line-height: 1;
        }
        .quote-source { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 12px; }
        .quote-meta { font-size: 0.9rem; }
        .quote-attribution { color: var(--text-secondary); margin-bottom: 4px; }
        .quote-attribution .author-name { font-weight: 500; }
        .quote-poem-title { color: var(--text-muted); font-style: italic; font-size: 0.9rem; }
        .quote-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }
        .quote-actions { display: flex; gap: 8px; }
        .quote-actions button { background: none; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; transition: all 0.2s; }
        .quote-actions button:hover { border-color: var(--accent); color: var(--accent); background: rgba(184, 149, 110, 0.05); }
        .quote-actions .delete-btn:hover { border-color: #c85050; color: #c85050; background: rgba(200, 80, 80, 0.05); }
        .quote-actions .read-btn { border-color: var(--accent); color: var(--accent); }
        .quote-actions .read-btn:hover { background: var(--accent); color: white; }

        /* Custom Text Selection - only on devices with a mouse pointer (desktop) */
        @media (pointer: fine) {
            ::selection {
                background-color: rgba(218, 190, 130, 0.45) !important;
                color: inherit !important;
            }
            ::-moz-selection {
                background-color: rgba(218, 190, 130, 0.45) !important;
                color: inherit !important;
            }
            .reader-poem-text ::selection {
                background-color: rgba(218, 190, 130, 0.55) !important;
            }
            .reader-poem-text ::-moz-selection {
                background-color: rgba(218, 190, 130, 0.55) !important;
            }
            [data-theme="dark"] ::selection {
                background-color: rgba(201, 166, 122, 0.35) !important;
                color: inherit !important;
            }
            [data-theme="dark"] ::-moz-selection {
                background-color: rgba(201, 166, 122, 0.35) !important;
                color: inherit !important;
            }
            [data-theme="dark"] .reader-poem-text ::selection {
                background-color: rgba(201, 166, 122, 0.45) !important;
            }
            [data-theme="dark"] .reader-poem-text ::-moz-selection {
                background-color: rgba(201, 166, 122, 0.45) !important;
            }
        }

        /* Mobile-only: push headers below status bar */
        body.platform-mobile .learning-header { padding-top: calc(15px + var(--status-bar-height, 0px)); }
        body.platform-mobile .reader-header { padding-top: calc(20px + var(--status-bar-height, 0px)); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rhapsode</h1>
            <p class="subtitle"><em>haec olim meminisse iuvabit</em></p>
            <div class="auth-buttons" id="auth-buttons">
                <button class="auth-btn auth-btn-secondary" onclick="openAuthModal('login')">Log In</button>
                <button class="auth-btn auth-btn-primary" onclick="openAuthModal('signup')">Sign Up</button>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </button>
        </header>
        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('home')">Home</button>
            <button class="tab-btn" onclick="switchTab('library')">Library</button>
            <button class="tab-btn" onclick="switchTab('my-poems')">My Poems</button>
            <button class="tab-btn" onclick="switchTab('quotes')">Quotes</button>
            <button class="tab-btn" onclick="switchTab('progress')">Progress</button>
        </nav>
        <div id="home-tab" class="tab-content active">
            <div class="home-welcome">
                <p class="home-welcome-text">"Memory is the mother of all wisdom."  Aeschylus</p>
            </div>
            <div class="home-hero" id="poem-of-day">
                <div class="home-hero-label"> Poem of the Day</div>
                <h2 class="home-hero-title" id="potd-title">Loading...</h2>
                <p class="home-hero-author" id="potd-author"></p>
                <div class="home-hero-preview" id="potd-preview"></div>
                <div class="home-hero-actions">
                    <button class="btn btn-primary" id="potd-read-btn" onclick="readPoemOfDay()">Read Full Poem</button>
                    <button class="btn btn-secondary" id="potd-add-btn" onclick="addPoemOfDay()">Add to My Poems</button>
                </div>
            </div>
            <div class="home-section">
                <h3 class="home-section-title">Popular This Week</h3>
                <div class="home-scroll" id="popular-poems"></div>
            </div>
            <div class="home-section">
                <h3 class="home-section-title">Staff Picks</h3>
                <div class="home-scroll" id="staff-picks"></div>
            </div>
            <div class="home-section">
                <h3 class="home-section-title">Seasonal</h3>
                <div class="home-scroll" id="seasonal-poems"></div>
            </div>
            <div class="home-section">
                <h3 class="home-section-title">Epigrams</h3>
                <div class="home-scroll" id="epigram-poems"></div>
            </div>
        </div>
        <div id="library-tab" class="tab-content">
            <h3 class="section-title">Collections</h3>
            <div class="collections-grid" id="collections-grid"></div>

            <h3 class="section-title">Themes</h3>
            <div class="theme-tags" id="theme-tags"></div>

            <h3 class="section-title">Search</h3>
            <div class="search-container">
                <input type="text" class="search-input" id="library-search" placeholder="Search by title, author, or line..." autocomplete="off">
            </div>
            <div class="filter-row">
                <select class="filter-select" id="era-filter" onchange="filterLibrary()">
                    <option value="">All Eras</option>
                    <option value="Ancient">Ancient</option>
                    <option value="Medieval">Medieval</option>
                    <option value="Renaissance">Renaissance</option>
                    <option value="Romantic">Romantic</option>
                    <option value="19th Century">19th Century</option>
                    <option value="Modern">Modern</option>
                    <option value="Contemporary">Contemporary</option>
                </select>
                <select class="filter-select" id="popularity-filter" onchange="filterLibrary()">
                    <option value="">All Popularity</option>
                    <option value="high">Famous</option>
                    <option value="medium">Well-known</option>
                    <option value="low">Lesser-known</option>
                </select>
                <button class="clear-filters" onclick="clearFilters()">Clear All</button>
            </div>
            <p class="library-stats" id="library-stats"></p>
            <div id="library-poems" class="poem-grid"></div>
            <button class="btn btn-secondary load-more" id="load-more-btn" onclick="loadMorePoems()" style="display:none;">Load More Poems</button>
        </div>
        <div id="my-poems-tab" class="tab-content">
            <div class="add-poem-section collapsed" id="add-poem-section">
                <div class="section-toggle" onclick="toggleAddPoemSection()"><h3>Add Custom Poem</h3><span class="toggle-icon">+</span></div>
                <div class="add-poem-form">
                    <div class="form-row">
                        <div class="form-group"><label>Title *</label><input type="text" id="custom-title" placeholder="Enter poem title"></div>
                        <div class="form-group"><label>Author</label><input type="text" id="custom-author" placeholder="Author name"></div>
                    </div>
                    <div class="form-group">
                        <label>Poem Text *</label>
                        <div class="editor-container">
                            <div class="editor-toolbar">
                                <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                                <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                                <button type="button" class="toolbar-btn" onclick="formatText('indent')" title="Indent">&#8594;</button>
                            </div>
                            <textarea id="custom-text" placeholder="Paste your poem here. Separate stanzas with blank lines."></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveCustomPoem()">Add to My Poems</button>
                </div>
            </div>
            <h3 class="section-title" style="margin-top: 10px;">My Poems</h3>
            <div id="my-poems-list" class="poem-grid"></div>
        </div>
        <div id="quotes-tab" class="tab-content">
            <h3 class="section-title">Saved Quotes <span class="count" id="quotes-count">(0)</span></h3>
            <div class="search-container">
                <input type="text" class="search-input" id="quotes-search" placeholder="Search quotes, poems, or authors..." oninput="handleQuotesSearch()">
            </div>
            <div id="quotes-list" class="quotes-grid"></div>
        </div>
        <div id="progress-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-memorized">0</div><div class="stat-label">Poems Memorized</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-lines">0</div><div class="stat-label">Lines Learned</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-in-progress">0</div><div class="stat-label">In Progress</div></div>
            </div>
            <h3 class="section-title">Achievements</h3>
            <div id="achievements-grid" class="achievements-grid"></div>
            <h3 class="section-title">Due for Review</h3>
            <div id="due-review-list" class="poem-grid"></div>
        </div>
        <footer class="app-footer">
            <a href="#" onclick="event.preventDefault(); openLegalModal('privacy');">Privacy Policy</a>
            <a href="#" onclick="event.preventDefault(); openLegalModal('terms');">Terms of Service</a>
            <a href="#" onclick="event.preventDefault(); openLegalModal('support');">Support</a>
        </footer>
    </div>
    <div class="modal-overlay" id="poem-modal" onclick="closeModal('poem-modal')">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 id="modal-title"></h2><button class="modal-close" onclick="closeModal('poem-modal')">&times;</button></div>
            <div class="modal-body">
                <p class="modal-author" id="modal-author"></p>
                <div class="modal-meta" id="modal-meta"></div>
                <div class="poem-text" id="modal-poem-text"></div>
            </div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal('poem-modal')">Close</button><button class="btn btn-primary" id="modal-add-btn" onclick="addToMyPoems()">Add to My Poems</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="auth-modal" onclick="closeModal('auth-modal')">
        <div class="modal auth-modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h2>Welcome</h2><button class="modal-close" onclick="closeModal('auth-modal')">&times;</button></div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Log In</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            <div class="modal-body">
                <div id="auth-error" class="auth-error"></div>
                <div id="auth-success" class="auth-success"></div>
                <div id="sync-notice" class="sync-notice" style="display:none;">
                    <strong>Welcome back!</strong> We found poems saved on this device. They will be synced to your account.
                </div>
                <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required minlength="6" placeholder="Your password">
                    </div>
                    <button type="submit" class="btn btn-primary">Log In</button>
                    <p class="auth-divider"><span class="auth-link" onclick="showForgotPassword()">Forgot password?</span></p>
                </form>
                <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required minlength="6" placeholder="At least 6 characters">
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm">Confirm Password</label>
                        <input type="password" id="signup-confirm" required minlength="6" placeholder="Confirm your password">
                    </div>
                    <div class="terms-checkbox">
                        <input type="checkbox" id="signup-terms" required>
                        <label for="signup-terms">I agree to the <a href="#" onclick="event.preventDefault(); event.stopPropagation(); openLegalModal('privacy');">Privacy Policy</a> and <a href="#" onclick="event.preventDefault(); event.stopPropagation(); openLegalModal('terms');">Terms of Service</a></label>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </form>
                <form id="forgot-form" class="auth-form" onsubmit="handleForgotPassword(event)">
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">Enter your email and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label for="forgot-email">Email</label>
                        <input type="email" id="forgot-email" required placeholder="your@email.com">
                    </div>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                    <p class="auth-divider"><span class="auth-link" onclick="switchAuthTab('login')">Back to login</span></p>
                </form>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="login-required-modal" onclick="closeModal('login-required-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Sign In Required</h2>
                <button class="modal-close" onclick="closeModal('login-required-modal')" style="position:absolute;top:20px;right:20px;">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">Create a free account to save poems to your collection.</p>
                <button class="btn btn-primary" onclick="closeModal('login-required-modal'); openModal('auth-modal');" style="width:100%;padding:15px;font-size:1.1rem;margin-bottom:15px;">
                    Sign Up / Log In
                </button>
                <button class="btn btn-secondary" onclick="closeModal('login-required-modal')" style="width:100%;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="settings-modal" onclick="closeModal('settings-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Settings</h2>
                <button class="modal-close" onclick="closeModal('settings-modal')" style="position:absolute;top:20px;right:20px;">&times;</button>
            </div>
            <div class="modal-body" style="padding:30px;">
                <div style="margin-bottom:25px;">
                    <label style="font-size:0.85rem;color:var(--text-secondary);display:block;margin-bottom:5px;">Account</label>
                    <span id="settings-account-email" style="font-size:1rem;color:var(--text-primary);"></span>
                </div>
                <button class="btn btn-secondary" onclick="closeModal('settings-modal'); openChangePasswordModal();" style="width:100%;margin-bottom:10px;">
                    Change Password
                </button>
                <button id="settings-manage-sub-btn" class="btn btn-secondary" onclick="closeModal('settings-modal'); manageSubscription();" style="width:100%;margin-bottom:10px;display:none;">
                    Manage Subscription
                </button>
                <button class="btn" onclick="closeModal('settings-modal'); openDeleteAccountModal();" style="width:100%;background:transparent;color:#c85050;border:1px solid #c85050;">
                    Delete Account
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="remove-poem-modal" onclick="closeModal('remove-poem-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Remove Poem?</h2>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">Are you sure you want to remove this poem from your collection?</p>
                <button class="btn btn-primary" onclick="closeModal('remove-poem-modal'); confirmRemovePoem();" style="width:100%;margin-bottom:10px;">
                    Remove
                </button>
                <button class="btn btn-secondary" onclick="closeModal('remove-poem-modal')" style="width:100%;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="delete-quote-modal" onclick="closeModal('delete-quote-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Delete Quote?</h2>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">Are you sure you want to delete this quote?</p>
                <button class="btn btn-secondary" onclick="closeModal('delete-quote-modal')" style="width:100%;margin-bottom:10px;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="closeModal('delete-quote-modal'); confirmDeleteQuote();" style="width:100%;">
                    Delete
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="logout-confirm-modal" onclick="closeModal('logout-confirm-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Log Out?</h2>
                <button class="modal-close" onclick="closeModal('logout-confirm-modal')" style="position:absolute;top:20px;right:20px;">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">Are you sure you want to log out?</p>
                <button class="btn btn-secondary" onclick="closeModal('logout-confirm-modal')" style="width:100%;margin-bottom:10px;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="closeModal('logout-confirm-modal'); handleLogout();" style="width:100%;">
                    Log Out
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="delete-warning-modal" onclick="closeModal('delete-warning-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Delete Account?</h2>
                <button class="modal-close" onclick="closeModal('delete-warning-modal')" style="position:absolute;top:20px;right:20px;">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">Are you sure? This will permanently erase all of your progress and saved poems.</p>
                <button class="btn btn-secondary" onclick="closeModal('delete-warning-modal')" style="width:100%;margin-bottom:10px;">
                    Cancel
                </button>
                <button class="btn btn-danger" onclick="closeModal('delete-warning-modal'); openDeleteConfirmModal();" style="width:100%;">
                    Yes, Delete My Account
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="delete-account-modal" onclick="closeModal('delete-account-modal')">
        <div class="modal delete-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <button class="modal-close" onclick="closeModal('delete-account-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Type <strong>DELETE</strong> to confirm:</p>
                <input type="text" id="delete-confirm-input" class="delete-confirm-input" placeholder="Type DELETE here" autocomplete="off">
                <div id="delete-account-error" class="auth-error"></div>
                <div class="delete-modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('delete-account-modal')">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="change-password-modal" onclick="closeModal('change-password-modal')">
        <div class="modal auth-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="modal-close" onclick="closeModal('change-password-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="change-password-error" class="auth-error"></div>
                <div id="change-password-success" class="auth-success"></div>
                <form id="change-password-form" onsubmit="handleChangePassword(event)">
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" required minlength="6" placeholder="At least 6 characters">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" required minlength="6" placeholder="Confirm new password">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="privacy-modal" onclick="closeModal('privacy-modal')">
        <div class="modal legal-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Privacy Policy</h2>
                <button class="modal-close" onclick="closeModal('privacy-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <p class="last-updated">Last updated: January 2025</p>
                    <p>Rhapsode (the app) collects and stores the following data when you create an account:</p>

                    <h3>WHAT WE COLLECT:</h3>
                    <ul>
                        <li>Email address (for login purposes)</li>
                        <li>Saved poems (poems you add to your collection)</li>
                        <li>Progress data (your memorization progress, stages completed, hints used)</li>
                        <li>Achievements earned</li>
                    </ul>

                    <h3>HOW WE USE IT:</h3>
                    <ul>
                        <li>To provide the service and save your progress</li>
                        <li>To sync your data across devices</li>
                        <li>To display your achievements</li>
                        <li>To generate anonymous community statistics (such as "Popular This Week" and trending poems)</li>
                    </ul>

                    <h3>COMMUNITY STATISTICS:</h3>
                    <ul>
                        <li>We track which poems are saved and practiced by users</li>
                        <li>This data is aggregated and anonymized to show community trends</li>
                        <li>Your individual activity is never publicly displayed or linked to your identity</li>
                        <li>Example: "Saved by 142 users this week" - we do not show WHO saved it</li>
                    </ul>

                    <h3>HOW WE STORE IT:</h3>
                    <ul>
                        <li>Your data is stored securely using Supabase (a cloud database provider)</li>
                        <li>We do not sell or share your personal data with third parties</li>
                        <li>We do not use your data for advertising</li>
                    </ul>

                    <h3>YOUR RIGHTS:</h3>
                    <ul>
                        <li>You can delete your account and all associated data at any time from your account settings</li>
                        <li>Account deletion is immediate and permanent</li>
                        <li>Anonymized aggregate data may remain in community statistics after deletion</li>
                    </ul>

                    <h3>COOKIES:</h3>
                    <ul>
                        <li>We use browser localStorage to cache data for performance</li>
                        <li>No tracking cookies are used</li>
                    </ul>

                    <h3>AGE REQUIREMENT:</h3>
                    <p>You must be 13 years or older to create an account.</p>

                    <p style="margin-top: 25px;">By creating an account, you consent to this data collection and data storage, and you affirm that you are at least 13 years of age.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="terms-modal" onclick="closeModal('terms-modal')">
        <div class="modal legal-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Terms of Service</h2>
                <button class="modal-close" onclick="closeModal('terms-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <p class="last-updated">Last updated: January 2025</p>
                    <p>By using Rhapsode, you agree to the following:</p>

                    <h3>1. ACCOUNT</h3>
                    <ul>
                        <li>You must provide a valid email address</li>
                        <li>You are responsible for your account security</li>
                        <li>You must be 13 years or older to use this service</li>
                        <li>You may delete your account at any time from your account settings</li>
                    </ul>

                    <h3>2. ACCEPTABLE USE</h3>
                    <ul>
                        <li>Do not abuse the service or attempt to access other users' data</li>
                        <li>Do not upload harmful or illegal content</li>
                    </ul>

                    <h3>3. CONTENT</h3>
                    <ul>
                        <li>The poem library consists of public domain works</li>
                        <li>Custom poems you add are your responsibility</li>
                    </ul>

                    <h3>4. SERVICE</h3>
                    <ul>
                        <li>The service is provided "as is"</li>
                        <li>We may modify or discontinue the service at any time</li>
                        <li>We are not liable for data loss</li>
                    </ul>

                    <h3>5. DATA AND COMMUNITY FEATURES</h3>
                    <ul>
                        <li>Your saved poems and activity may be included in anonymous aggregate statistics</li>
                        <li>These statistics help show community trends like popular poems</li>
                        <li>Your identity is never revealed in these statistics</li>
                        <li>See our Privacy Policy for full details</li>
                    </ul>

                    <h3>6. ACCOUNT DELETION</h3>
                    <ul>
                        <li>You may delete your account at any time from your account settings</li>
                        <li>Deleting your account permanently removes all your data including saved poems, progress, and achievements</li>
                        <li>This action cannot be undone</li>
                        <li>Anonymized aggregate data (e.g., poem save counts) may remain in community statistics</li>
                    </ul>

                    <h3>7. CHANGES</h3>
                    <ul>
                        <li>We may update these terms at any time</li>
                        <li>Continued use means acceptance of new terms</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="support-modal" onclick="closeModal('support-modal')">
        <div class="modal legal-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Support</h2>
                <button class="modal-close" onclick="closeModal('support-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <p><strong>Rhapsode</strong></p>
                    <p>Contact us: <a href="mailto:support@rhapsode.io" style="color:var(--accent);">support@rhapsode.io</a></p>

                    <h3>Frequently Asked Questions</h3>

                    <h4>How do I reset my password?</h4>
                    <p>If you are logged in, go to <strong>Settings &gt; Change Password</strong>. If you are logged out, tap <strong>"Forgot Password"</strong> on the login screen to receive a reset link by email.</p>

                    <h4>How do I cancel my subscription?</h4>
                    <p>On iOS, go to <strong>Settings &gt; Apple ID &gt; Subscriptions</strong> on your device. You can also use the <strong>"Manage Subscription"</strong> button in the app's Settings if available.</p>

                    <h4>I have a billing question</h4>
                    <p>For any billing inquiries, please contact us at <a href="mailto:support@rhapsode.io" style="color:var(--accent);">support@rhapsode.io</a>.</p>

                    <h4>How do I delete my account?</h4>
                    <p>Go to <strong>Settings &gt; Delete Account</strong>. This will permanently remove all your data including saved poems, progress, and achievements.</p>

                    <h4>How do I report a bug?</h4>
                    <p>Please email <a href="mailto:support@rhapsode.io" style="color:var(--accent);">support@rhapsode.io</a> with a description of the issue and any relevant screenshots.</p>

                    <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
                    <p>
                        <a href="#" onclick="event.preventDefault(); closeModal('support-modal'); openLegalModal('privacy');" style="color:var(--accent);">Privacy Policy</a> &nbsp;&middot;&nbsp;
                        <a href="#" onclick="event.preventDefault(); closeModal('support-modal'); openLegalModal('terms');" style="color:var(--accent);">Terms of Service</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="manage-sub-modal" onclick="closeModal('manage-sub-modal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;position:relative;">
            <div class="modal-header" style="text-align:center;display:block;padding:24px 30px 0;">
                <h2 style="margin:0;">Manage Subscription</h2>
                <button class="modal-close" onclick="closeModal('manage-sub-modal')" style="position:absolute;top:20px;right:20px;">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:30px;">
                <p style="font-size:1.1rem;margin-bottom:25px;color:var(--text-secondary);">This will open your App Store subscription settings where you can cancel or modify your subscription.</p>
                <button class="btn btn-primary" onclick="closeModal('manage-sub-modal'); executeManageSubscription();" style="width:100%;margin-bottom:10px;">
                    Open Subscription Settings
                </button>
                <button class="btn btn-secondary" onclick="closeModal('manage-sub-modal')" style="width:100%;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div class="learning-container" id="learning-container">
        <div class="learning-header">
            <div class="learning-header-left">
                <button class="btn btn-secondary btn-small" onclick="exitLearning()">Exit</button>
            </div>
            <div class="learning-header-center">
                <div class="learning-header-title-row">
                    <button class="stage-skip-btn" id="prev-stage-btn" onclick="navigateStage(-1)" title="Previous Stage">&larr;</button>
                    <span class="learning-title" id="learning-poem-title"></span>
                    <button class="stage-skip-btn" id="next-stage-btn" onclick="navigateStage(1)" title="Skip Stage">&rarr;</button>
                </div>
                <span class="learning-stage" id="learning-stage-label"></span>
            </div>
            <div class="learning-header-right"></div>
        </div>
        <div class="learning-body" id="learning-body"></div>
        <div class="learning-footer">
            <button class="btn btn-primary" id="next-button" onclick="handleNext()">Next</button>
        </div>
    </div>
    <div class="reader-container" id="reader-container">
        <div class="reader-header">
            <div class="reader-header-left">
                <button class="btn btn-secondary btn-small" onclick="closeReader()">Close</button>
                <span class="reader-title" id="reader-poem-title"></span>
            </div>
        </div>
        <div class="reader-body">
            <h1 class="reader-poem-title" id="reader-title-display"></h1>
            <p class="reader-poem-author" id="reader-author-display"></p>
            <div class="reader-poem-text" id="reader-poem-text"></div>
        </div>
    </div>
    <div class="quote-popup-overlay" id="quote-popup-overlay" onclick="hideQuotePopup()"></div>
    <div class="quote-popup" id="quote-popup">
        <div class="quote-popup-text" id="quote-popup-text"></div>
        <div class="quote-popup-buttons">
            <button class="quote-popup-btn" onclick="copySelectedText()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy
            </button>
            <button class="quote-popup-btn primary" onclick="saveQuoteFromSelection()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add to Quotes
            </button>
        </div>
    </div>
    <div class="toast" id="toast">
        <div class="toast-title" id="toast-title"></div>
        <div class="toast-message" id="toast-message"></div>
    </div>
    <!-- Admin Panel -->
    <div class="admin-overlay" id="admin-panel">
        <div class="admin-container">
            <!-- Login Form (shown when not authenticated) -->
            <div id="admin-login-view">
                <div class="admin-login">
                    <h2>Admin Access</h2>
                    <div id="admin-login-error" class="auth-error"></div>
                    <form onsubmit="handleAdminLogin(event)">
                        <div class="form-group">
                            <input type="password" id="admin-password" placeholder="Enter admin password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Access Admin Panel</button>
                    </form>
                    <p style="text-align:center;margin-top:15px;"><a href="#" onclick="closeAdmin()" style="color:var(--text-muted);font-size:0.9rem;">Back to App</a></p>
                </div>
            </div>
            <!-- Dashboard (shown when authenticated) -->
            <div id="admin-dashboard" style="display:none;">
                <div class="admin-header">
                    <h1>Admin Dashboard</h1>
                    <button class="btn btn-secondary" onclick="closeAdmin()">Back to App</button>
                </div>
                <!-- Staff Picks Manager -->
                <div class="admin-section">
                    <h2>Staff Picks</h2>
                    <div id="admin-staff-picks-list" class="admin-poem-list"></div>
                    <h3 style="font-size:1rem;margin-bottom:10px;color:var(--text-secondary);">Add Poem to Staff Picks</h3>
                    <div class="admin-search">
                        <input type="text" id="admin-staff-search" placeholder="Search poems..." oninput="searchPoemsForAdmin('staff')">
                    </div>
                    <div id="admin-staff-results" class="admin-results" style="display:none;"></div>
                    <div class="admin-actions">
                        <button class="btn btn-primary" onclick="saveStaffPicks()">Save Staff Picks</button>
                        <span id="staff-picks-saved" class="admin-saved" style="display:none;">Saved!</span>
                    </div>
                </div>
                <!-- Monthly Challenge Manager -->
                <div class="admin-section">
                    <h2>Monthly Challenge</h2>
                    <div id="admin-monthly-current" class="admin-current">
                        <div class="admin-current-label">Current Challenge</div>
                        <div class="admin-current-value" id="monthly-current-display">None set</div>
                    </div>
                    <div class="admin-row">
                        <div class="form-group">
                            <label>Select Poem</label>
                            <select id="admin-monthly-poem">
                                <option value="">-- Select a poem --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Month</label>
                            <input type="month" id="admin-monthly-month">
                        </div>
                    </div>
                    <div class="admin-actions">
                        <button class="btn btn-primary" onclick="saveMonthlyChallenge()">Save Monthly Challenge</button>
                        <button class="btn btn-secondary" onclick="clearMonthlyChallenge()">Clear Challenge</button>
                        <span id="monthly-saved" class="admin-saved" style="display:none;">Saved!</span>
                    </div>
                </div>
                <!-- Poem of the Day Override -->
                <div class="admin-section">
                    <h2>Poem of the Day Override</h2>
                    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:15px;">Leave blank to use automatic daily selection.</p>
                    <div id="admin-potd-current" class="admin-current">
                        <div class="admin-current-label">Current Override</div>
                        <div class="admin-current-value" id="potd-current-display">None (using automatic selection)</div>
                    </div>
                    <div class="admin-row">
                        <div class="form-group">
                            <label>Select Poem</label>
                            <select id="admin-potd-poem">
                                <option value="">-- No override (automatic) --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="admin-potd-date">
                        </div>
                    </div>
                    <div class="admin-actions">
                        <button class="btn btn-primary" onclick="savePotdOverride()">Save Override</button>
                        <button class="btn btn-secondary" onclick="clearPotdOverride()">Clear Override</button>
                        <span id="potd-saved" class="admin-saved" style="display:none;">Saved!</span>
                    </div>
                </div>
                <!-- Collections Management -->
                <div class="admin-section">
                    <h2>Collections Management</h2>
                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="switchAdminCollectionTab('list')">All Collections</button>
                        <button class="admin-tab" onclick="switchAdminCollectionTab('add')">Add Collection</button>
                        <button class="admin-tab" onclick="switchAdminCollectionTab('manage')">Manage Poems</button>
                    </div>
                    <!-- Collections List -->
                    <div id="admin-collection-list-tab" class="admin-tab-content active">
                        <div id="admin-collections-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin-top:15px;"></div>
                    </div>
                    <!-- Add Collection -->
                    <div id="admin-collection-add-tab" class="admin-tab-content" style="display:none;">
                        <div class="admin-form">
                            <div class="form-group">
                                <label>Collection Name *</label>
                                <input type="text" id="admin-collection-name" placeholder="e.g., Victorian Poetry">
                            </div>
                            <div class="form-group">
                                <label>Collection ID (auto-generated)</label>
                                <input type="text" id="admin-collection-id" placeholder="Will be generated from name" readonly style="background:var(--bg-secondary);color:var(--text-muted);">
                            </div>
                            <div class="admin-actions">
                                <button class="btn btn-primary" onclick="saveNewCollection()">Create Collection</button>
                            </div>
                        </div>
                    </div>
                    <!-- Manage Poems in Collection -->
                    <div id="admin-collection-manage-tab" class="admin-tab-content" style="display:none;">
                        <div class="form-group">
                            <label>Select Collection</label>
                            <select id="admin-manage-collection-select" onchange="loadCollectionPoems()">
                                <option value="">-- Select a collection --</option>
                            </select>
                        </div>
                        <div id="admin-collection-poems" style="display:none;">
                            <h3 style="font-size:1rem;margin:20px 0 10px;color:var(--text-secondary);">Poems in this Collection</h3>
                            <div id="admin-collection-poem-list" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-bottom:20px;"></div>
                            <h3 style="font-size:1rem;margin:20px 0 10px;color:var(--text-secondary);">Add Poems to Collection</h3>
                            <div class="admin-search">
                                <input type="text" id="admin-collection-poem-search" placeholder="Search poems to add..." oninput="searchPoemsForCollection()">
                            </div>
                            <div id="admin-collection-search-results" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px;display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Poem Management -->
                <div class="admin-section">
                    <h2>Poem Library Management</h2>
                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="switchAdminPoemTab('list')">All Poems</button>
                        <button class="admin-tab" onclick="switchAdminPoemTab('add')">Add Poem</button>
                        <button class="admin-tab" onclick="switchAdminPoemTab('bulk')">Bulk Import</button>
                    </div>
                    <!-- Poem List -->
                    <div id="admin-poem-list-tab" class="admin-tab-content active">
                        <div class="admin-search" style="margin-bottom:15px;">
                            <input type="text" id="admin-poem-search" placeholder="Search by title or author..." oninput="filterAdminPoemList()">
                        </div>
                        <div id="admin-poem-count" class="admin-count"></div>
                        <div style="overflow-x:auto;">
                            <table class="admin-poem-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Stanzas</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-poem-tbody"></tbody>
                            </table>
                        </div>
                        <div id="admin-poem-pagination" class="admin-pagination"></div>
                    </div>
                    <!-- Add Poem -->
                    <div id="admin-poem-add-tab" class="admin-tab-content">
                        <div class="admin-form">
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Title *</label>
                                    <input type="text" id="admin-poem-title" placeholder="Poem title">
                                </div>
                                <div class="form-group">
                                    <label>Author *</label>
                                    <input type="text" id="admin-poem-author" placeholder="Author name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Poem Text * (separate stanzas with blank lines)</label>
                                <textarea id="admin-poem-text" placeholder="Paste the poem here..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Themes</label>
                                <div id="admin-poem-themes" class="checkbox-group"></div>
                            </div>
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Popularity</label>
                                    <select id="admin-poem-popularity">
                                        <option value="">-- Select --</option>
                                        <option value="high">High (Famous)</option>
                                        <option value="medium">Medium (Well-known)</option>
                                        <option value="low">Low (Lesser-known)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Era</label>
                                    <select id="admin-poem-era">
                                        <option value="">-- Select --</option>
                                        <option value="Ancient">Ancient</option>
                                        <option value="Medieval">Medieval</option>
                                        <option value="Renaissance">Renaissance</option>
                                        <option value="Romantic">Romantic</option>
                                        <option value="19th Century">19th Century</option>
                                        <option value="Modern">Modern</option>
                                        <option value="Contemporary">Contemporary</option>
                                    </select>
                                </div>
                            </div>
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Collections</label>
                                    <div id="admin-poem-collections" class="checkbox-group"></div>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="btn btn-secondary" onclick="previewAdminPoem()">Preview</button>
                                <button class="btn btn-primary" onclick="saveAdminPoem()">Save Poem</button>
                            </div>
                            <div id="admin-poem-preview" class="admin-preview" style="display:none;"></div>
                        </div>
                    </div>
                    <!-- Edit Poem (hidden by default, shown when editing) -->
                    <div id="admin-poem-edit-tab" class="admin-tab-content">
                        <div class="admin-form">
                            <input type="hidden" id="admin-edit-poem-id">
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Title *</label>
                                    <input type="text" id="admin-edit-title" placeholder="Poem title">
                                </div>
                                <div class="form-group">
                                    <label>Author *</label>
                                    <input type="text" id="admin-edit-author" placeholder="Author name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Poem Text * (separate stanzas with blank lines)</label>
                                <textarea id="admin-edit-text" placeholder="Paste the poem here..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Themes</label>
                                <div id="admin-edit-themes" class="checkbox-group"></div>
                            </div>
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Popularity</label>
                                    <select id="admin-edit-popularity">
                                        <option value="">-- Select --</option>
                                        <option value="high">High (Famous)</option>
                                        <option value="medium">Medium (Well-known)</option>
                                        <option value="low">Low (Lesser-known)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Era</label>
                                    <select id="admin-edit-era">
                                        <option value="">-- Select --</option>
                                        <option value="Ancient">Ancient</option>
                                        <option value="Medieval">Medieval</option>
                                        <option value="Renaissance">Renaissance</option>
                                        <option value="Romantic">Romantic</option>
                                        <option value="19th Century">19th Century</option>
                                        <option value="Modern">Modern</option>
                                        <option value="Contemporary">Contemporary</option>
                                    </select>
                                </div>
                            </div>
                            <div class="admin-row">
                                <div class="form-group">
                                    <label>Collections</label>
                                    <div id="admin-edit-collections" class="checkbox-group"></div>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="btn btn-secondary" onclick="switchAdminPoemTab('list')">Cancel</button>
                                <button class="btn btn-primary" onclick="updateAdminPoem()">Save Changes</button>
                                <button class="btn btn-secondary" style="border-color:rgba(200,80,80,0.3);color:#c85050;" onclick="deleteAdminPoem()">Delete Poem</button>
                            </div>
                            <div id="admin-edit-preview" class="admin-preview" style="display:none;"></div>
                        </div>
                    </div>
                    <!-- Bulk Import -->
                    <div id="admin-poem-bulk-tab" class="admin-tab-content">
                        <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:15px;">
                            Paste multiple poems below. Format: Title on first line, Author on second line, then poem text. Separate poems with <code>---</code> on its own line.
                        </p>
                        <div class="admin-form">
                            <div class="form-group">
                                <label>Bulk Poem Text</label>
                                <textarea id="admin-bulk-text" class="admin-bulk-textarea" placeholder="The Tyger
William Blake

Tyger Tyger, burning bright,
In the forests of the night;
What immortal hand or eye,
Could frame thy fearful symmetry?

---

The Lamb
William Blake

Little Lamb who made thee
Dost thou know who made thee"></textarea>
                            </div>
                            <div class="admin-actions">
                                <button class="btn btn-secondary" onclick="parseBulkPoems()">Parse & Preview</button>
                                <button class="btn btn-primary" id="bulk-import-btn" onclick="importBulkPoems()" disabled>Import All</button>
                            </div>
                            <div id="admin-bulk-preview" class="admin-bulk-preview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Supabase CDN -->
    <script src="supabase-cdn.js"></script>
    <script src="supabase.js"></script>

    <script>
// Data (loaded from JSON files)
let POEM_LIBRARY = [];
let COLLECTIONS = [];
let SEARCH_INDEX = null;
let AUTHORS = [];
let libraryLoaded = false;

// Auth State
let currentUser = null;
let userPoemsCache = null;  // Cache for Supabase poems to avoid refetching

function isSubscribed() {
    return true;
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.add('active');
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.remove('active');
}


// State
let displayedCount = 20;
let filteredPoems = [];
let activeCollection = null;
let activeTheme = null;
let currentModalPoem = null;
let learningState = { poem: null, stage: 1, repetition: 1, currentLine: 0, hintLevel: 0, hintsUsed: 0, lineHintLevels: {}, mode: 'learn' };

const STAGES = {
    1: { name: 'Initial Reading', repetitions: 3 },
    2: { name: 'Missing Key Words', repetitions: 1 },
    3: { name: 'Missing Every Other Word', repetitions: 1 },
    4: { name: 'First Word Only', repetitions: 1 },
    5: { name: 'First Letter Only', repetitions: 1 },
    6: { name: 'Full Recitation', repetitions: 1 }
};

// Spaced repetition review intervals (days)
const REVIEW_INTERVALS = [1, 3, 7, 14, 30];

// Migrate old poem data structure to new format
function migratePoem(oldPoem) {
    if (oldPoem.currentStage !== undefined) return oldPoem; // Already migrated
    const oldStage = oldPoem.stage || 1;
    const wasMemorized = oldStage >= 7; // Old stage 7+ means completed (was 8 for mastered, 7 for full recitation)

    // Map old stages to new (old stage 6 "Structure Only" removed, old stage 7 -> new stage 6)
    let newStage = oldStage;
    if (oldStage >= 6) newStage = Math.min(oldStage - 1, 6);

    return {
        ...oldPoem,
        currentStage: Math.min(newStage, 6),
        lastStage: Math.min(newStage, 6),
        completedStage6: wasMemorized,
        successfulRecitations: wasMemorized ? 3 : 0,
        isMemorized: wasMemorized,
        memorizedDate: wasMemorized ? (oldPoem.lastPracticed || Date.now()) : null,
        lastReviewDate: oldPoem.lastPracticed || null,
        nextReviewDate: null,
        reviewHistory: [],
        // Keep old fields for backward compatibility during transition
        stage: oldPoem.stage,
        stageRepetition: oldPoem.stageRepetition
    };
}

// Achievement definitions
// Helper to check if a poem has "Steel Trap" status (successfully recited 1+ month after memorizing)
function hasSteelTrapStatus(poem) {
    if (!poem.isMemorized || !poem.memorizedDate) return false;
    const oneMonthAfterMemorized = poem.memorizedDate + (30 * 86400000);
    const history = poem.reviewHistory || [];
    // Check if any successful review occurred 1+ month after memorization
    return history.some(review => review.result === 'easy' && review.date >= oneMonthAfterMemorized);
}

const ACHIEVEMENTS = [
    {
        id: 'party-trick',
        name: 'Party Trick',
        description: 'Memorize your first poem (3 successful recitations).',
        phrase: 'Your classical education has begun.',
        check: (poems) => poems.some(p => p.isMemorized)
    },
    {
        id: 'steel-trap',
        name: 'Steel Trap',
        description: 'Successfully recite a poem 1 month after marking it memorized.',
        phrase: 'The mother of the muses has given you the gift of memory.',
        check: (poems) => poems.some(p => hasSteelTrapStatus(p))
    },
    {
        id: 'bard',
        name: 'Bard',
        description: 'Achieve \'Steel Trap\' status on 10 poems.',
        phrase: 'The king requests your presence in the great hall.',
        check: (poems) => poems.filter(p => hasSteelTrapStatus(p)).length >= 10
    },
    {
        id: 'rhapsode',
        name: 'Rhapsode',
        description: 'Achieve \'Steel Trap\' status on 50 poems.',
        phrase: 'Homer kneels.',
        check: (poems) => poems.filter(p => hasSteelTrapStatus(p)).length >= 50
    }
];

// LocalStorage (fallback when not logged in)
function getLocalPoems() { return JSON.parse(localStorage.getItem('mnemosyne_my_poems') || '[]'); }
function saveLocalPoems(poems) { localStorage.setItem('mnemosyne_my_poems', JSON.stringify(poems)); }
function getSettings() { return JSON.parse(localStorage.getItem('mnemosyne_settings') || '{"darkMode": false}'); }
function saveSettings(settings) { localStorage.setItem('mnemosyne_settings', JSON.stringify(settings)); }
function getLocalAchievements() { return JSON.parse(localStorage.getItem('mnemosyne_achievements') || '[]'); }
function saveLocalAchievements(achievements) { localStorage.setItem('mnemosyne_achievements', JSON.stringify(achievements)); }

// Hybrid data functions - use Supabase when logged in, localStorage when not
async function getMyPoems() {
    let poems;
    if (currentUser && typeof fetchUserPoems === 'function') {
        if (userPoemsCache) {
            poems = userPoemsCache;
        } else {
            const online = typeof isAppOnline === 'function' ? isAppOnline() : navigator.onLine;
            if (online) {
                const fetched = await fetchUserPoems(currentUser.id);
                if (fetched.length > 0) {
                    userPoemsCache = fetched;
                    poems = fetched;
                } else {
                    // Could be genuinely empty or a network error  fall back to localStorage
                    poems = getLocalPoems();
                }
            } else {
                // Offline  use localStorage backup
                poems = getLocalPoems();
            }
        }
    } else {
        poems = getLocalPoems();
    }

    return poems;
}

async function saveMyPoems(poems) {
    // Always save to localStorage as backup
    saveLocalPoems(poems);

    // If logged in, also save to Supabase
    if (currentUser && typeof syncAllPoems === 'function') {
        try {
            await syncAllPoems(currentUser.id, poems);
            userPoemsCache = poems;
        } catch (e) {
            console.error('Error syncing to Supabase:', e);
        }
    }
}

async function saveOnePoem(poem) {
    // Update local cache
    const poems = await getMyPoems();
    const idx = poems.findIndex(p => p.id === poem.id);
    const isNewPoem = idx < 0;
    if (idx >= 0) poems[idx] = poem;
    else poems.push(poem);

    saveLocalPoems(poems);

    // Always update memory cache immediately so subsequent reads see the changes
    if (currentUser) {
        userPoemsCache = poems;
    }

    if (currentUser && typeof saveUserPoem === 'function') {
        try {
            await saveUserPoem(currentUser.id, poem);
            if (isNewPoem && typeof recordPoemSave === 'function') {
                await recordPoemSave(poem.id);
                if (typeof clearPopularCache === 'function') clearPopularCache();
            }
        } catch (e) {
            console.error('Error saving poem to Supabase:', e);
        }
    }
}

async function removeOnePoemFromStorage(poemId) {
    const poems = (await getMyPoems()).filter(p => p.id !== poemId);
    saveLocalPoems(poems);
    userPoemsCache = poems;

    if (currentUser && typeof removeUserPoem === 'function') {
        try {
            await removeUserPoem(currentUser.id, poemId);
            if (typeof removePoemSave === 'function') {
                await removePoemSave(poemId);
                if (typeof clearPopularCache === 'function') clearPopularCache();
            }
        } catch (e) {
            console.error('Error removing poem from Supabase:', e);
        }
    }
}

// Achievement functions
function getEarnedAchievements() {
    // For now, just use localStorage (can extend to Supabase later)
    return getLocalAchievements();
}

function saveEarnedAchievements(achievements) {
    saveLocalAchievements(achievements);
}

async function checkAchievements() {
    const myPoems = await getMyPoems();
    const migratedPoems = myPoems.map(migratePoem);
    const earned = getEarnedAchievements();
    const earnedIds = new Set(earned.map(a => a.id));
    const newlyEarned = [];

    for (const achievement of ACHIEVEMENTS) {
        if (!earnedIds.has(achievement.id) && achievement.check(migratedPoems)) {
            newlyEarned.push({ id: achievement.id, earnedAt: new Date().toISOString() });
        }
    }

    if (newlyEarned.length > 0) {
        saveEarnedAchievements([...earned, ...newlyEarned]);
        // Show toast for each new achievement
        for (const a of newlyEarned) {
            const achievement = ACHIEVEMENTS.find(ach => ach.id === a.id);
            if (achievement) showToast('Achievement Unlocked!', achievement.name);
        }
    }
}

function showToast(title, message) {
    const toast = document.getElementById('toast');
    document.getElementById('toast-title').textContent = title;
    document.getElementById('toast-message').textContent = message;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 3500);
}

async function renderAchievements() {
    const container = document.getElementById('achievements-grid');
    const earned = getEarnedAchievements();
    const earnedMap = new Map(earned.map(a => [a.id, a]));
    const myPoems = await getMyPoems();
    const migratedPoems = myPoems.map(migratePoem);

    container.innerHTML = ACHIEVEMENTS.map(achievement => {
        const earnedData = earnedMap.get(achievement.id);
        const isEarned = !!earnedData;
        const dateStr = earnedData ? new Date(earnedData.earnedAt).toLocaleDateString() : '';

        // Calculate progress text for locked achievements
        let progressText = '';
        if (!isEarned) {
            const steelTrapCount = migratedPoems.filter(p => hasSteelTrapStatus(p)).length;
            if (achievement.id === 'party-trick') {
                // Show progress toward first memorization
                const bestPoem = migratedPoems
                    .filter(p => p.completedStage6 || p.successfulRecitations > 0)
                    .sort((a, b) => (b.successfulRecitations || 0) - (a.successfulRecitations || 0))[0];
                if (bestPoem) {
                    const recitations = bestPoem.successfulRecitations || 0;
                    progressText = `Best progress: ${recitations}/3 successful recitations`;
                }
            } else if (achievement.id === 'steel-trap') {
                // Show progress toward Steel Trap (days since memorization)
                const bestPoem = migratedPoems
                    .filter(p => p.isMemorized && p.memorizedDate)
                    .sort((a, b) => (a.memorizedDate || 0) - (b.memorizedDate || 0))[0];
                if (bestPoem) {
                    const daysMemorized = Math.floor((Date.now() - bestPoem.memorizedDate) / 86400000);
                    progressText = `Oldest memorized: ${daysMemorized}/30 days`;
                }
            } else if (achievement.id === 'bard') {
                progressText = `${steelTrapCount}/10 poems with Steel Trap status`;
            } else if (achievement.id === 'rhapsode') {
                progressText = `${steelTrapCount}/50 poems with Steel Trap status`;
            }
        }

        const phraseHtml = (isEarned && achievement.phrase) ? `<div class="achievement-phrase">${achievement.phrase}</div>` : '';
        return `<div class="achievement-card ${isEarned ? 'earned' : 'locked'}">
            <div class="achievement-name">${achievement.name}</div>
            <div class="achievement-desc">${achievement.description}</div>
            ${phraseHtml}
            ${isEarned ? `<div class="achievement-status">Earned ${dateStr}</div>` : (progressText ? `<div class="achievement-status">${progressText}</div>` : '')}
        </div>`;
    }).join('');
}

// =====================================
// HOME TAB FUNCTIONS
// =====================================

// Placeholder data for Popular This Week (will be replaced with Supabase data later)
const POPULAR_THIS_WEEK = [
    { poemId: 'shelley-ozymandias', saves: 142 },
    { poemId: 'blake-the-tyger', saves: 98 },
    { poemId: 'keats-ode-to-a-nightingale', saves: 87 },
    { poemId: 'coleridge-kubla-khan', saves: 76 },
    { poemId: 'wordsworth-i-wandered-lonely-as-a-cloud', saves: 71 },
    { poemId: 'byron-she-walks-in-beauty', saves: 65 },
    { poemId: 'keats-ode-on-a-grecian-urn', saves: 58 },
    { poemId: 'keats-to-autumn', saves: 52 }
];

// Staff Picks - curated favorites
const STAFF_PICKS = [
    { poemId: 'keats-ode-to-a-nightingale', note: 'A meditation on mortality' },
    { poemId: 'wordsworth-tintern-abbey', note: 'Nature and memory intertwined' },
    { poemId: 'coleridge-frost-at-midnight', note: 'Intimate and tender' },
    { poemId: 'shelley-ode-to-the-west-wind', note: 'Raw poetic power' },
    { poemId: 'byron-darkness', note: 'Apocalyptic vision' },
    { poemId: 'keats-ode-on-melancholy', note: 'Beauty in sadness' }
];

// Seasonal poems (winter for January)
const SEASONAL = [
    { poemId: 'coleridge-frost-at-midnight', note: 'Winter contemplation' },
    { poemId: 'keats-ode-on-melancholy', note: 'For darker months' },
    { poemId: 'wordsworth-a-slumber-did-my-spirit-seal', note: 'Winter stillness' },
    { poemId: 'byron-so-well-go-no-more-a-roving', note: 'End of revelry' }
];

// Epigrams - short, memorable verses
const EPIGRAMS = [
    { poemId: 'blake-the-sick-rose', note: '8 lines' },
    { poemId: 'wordsworth-a-slumber-did-my-spirit-seal', note: '8 lines' },
    { poemId: 'blake-infant-joy', note: '12 lines' },
    { poemId: 'blake-infant-sorrow', note: '8 lines' },
    { poemId: 'keats-bright-star', note: 'Sonnet' },
    { poemId: 'shelley-ozymandias', note: 'Sonnet' }
];

// Date-seeded random number generator for consistent daily poem
function seededRandom(seed) {
    const x = Math.sin(seed) * 10000;
    return x - Math.floor(x);
}

function getPoemOfDay(override = null) {
    if (!POEM_LIBRARY || POEM_LIBRARY.length === 0) return null;

    // Check for override first
    if (override && override.poem_id) {
        const today = new Date().toISOString().split('T')[0];
        // Only use override if it's for today (or no date specified)
        if (!override.date || override.date === today) {
            const poem = POEM_LIBRARY.find(p => p.id === override.poem_id);
            if (poem) return poem;
        }
    }

    // Use today's date as the seed (same poem all day, changes at midnight)
    const today = new Date();
    const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
    const index = Math.floor(seededRandom(seed) * POEM_LIBRARY.length);
    return POEM_LIBRARY[index];
}

let poemOfDayCache = null;
let homeSettingsLoaded = false;
let cachedHomeSettings = null;

async function loadHomeSettings() {
    if (homeSettingsLoaded) return cachedHomeSettings;

    if (typeof getAllAppSettings === 'function' && isSupabaseConfigured()) {
        try {
            cachedHomeSettings = await getAllAppSettings();
            homeSettingsLoaded = true;

            // Update STAFF_PICKS if we have them from Supabase
            if (cachedHomeSettings.staff_picks && Array.isArray(cachedHomeSettings.staff_picks)) {
                STAFF_PICKS.length = 0;
                cachedHomeSettings.staff_picks.forEach(p => STAFF_PICKS.push(p));
            }

            return cachedHomeSettings;
        } catch (e) {
            console.error('Failed to load home settings:', e);
        }
    }
    homeSettingsLoaded = true;
    return {};
}

async function renderHome() {
    if (!libraryLoaded) return;

    // Load settings from Supabase (cached after first load)
    const settings = await loadHomeSettings();

    // Poem of the Day (check for override)
    poemOfDayCache = getPoemOfDay(settings.potd_override);
    if (poemOfDayCache) {
        document.getElementById('potd-title').textContent = poemOfDayCache.title;
        document.getElementById('potd-author').textContent = `by ${poemOfDayCache.author}`;

        // Get first stanza as preview
        const stanzas = getStanzas(poemOfDayCache);
        const firstStanza = stanzas[0] || [];
        document.getElementById('potd-preview').textContent = firstStanza.join('\n');
    }

    // Popular This Week - fetch real data from Supabase
    const popularContainer = document.getElementById('popular-poems');
    let popularData = [];

    // Try to get real popular data from Supabase
    if (typeof getPopularThisWeek === 'function') {
        try {
            popularData = await getPopularThisWeek(10);
        } catch (e) {
            console.error('Error fetching popular poems:', e);
        }
    }

    // If we have fewer than 5 popular poems, supplement with fallback data
    const MIN_POPULAR_COUNT = 5;
    if (popularData.length < MIN_POPULAR_COUNT) {
        const existingIds = new Set(popularData.map(p => p.poem_id));
        const fallbackPoems = POPULAR_THIS_WEEK
            .filter(item => !existingIds.has(item.poemId))
            .slice(0, MIN_POPULAR_COUNT - popularData.length)
            .map(item => ({ poem_id: item.poemId, save_count: item.saves, isFallback: true }));
        popularData = [...popularData, ...fallbackPoems];
    }

    popularContainer.innerHTML = popularData.map(item => {
        const poem = POEM_LIBRARY.find(p => p.id === item.poem_id);
        if (!poem) return '';
        const saveText = item.isFallback
            ? `Popular classic`
            : `Saved by ${item.save_count} user${item.save_count !== 1 ? 's' : ''} this week`;
        return `<div class="home-card" onclick="openPoem('${poem.id}')" ondblclick="openReaderFromLibrary('${poem.id}')">
            <div class="home-card-title">${poem.title}</div>
            <div class="home-card-author">by ${poem.author}</div>
            <div class="home-card-stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                ${saveText}
            </div>
        </div>`;
    }).join('');

    // Staff Picks
    const staffContainer = document.getElementById('staff-picks');
    staffContainer.innerHTML = STAFF_PICKS.map(item => {
        const poem = POEM_LIBRARY.find(p => p.id === item.poemId);
        if (!poem) return '';
        return `<div class="home-card" onclick="openPoem('${poem.id}')" ondblclick="openReaderFromLibrary('${poem.id}')">
            <div class="home-card-title">${poem.title}</div>
            <div class="home-card-author">by ${poem.author}</div>
            <div class="home-card-stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                ${item.note}
            </div>
        </div>`;
    }).join('');

    // Seasonal
    const seasonalContainer = document.getElementById('seasonal-poems');
    seasonalContainer.innerHTML = SEASONAL.map(item => {
        const poem = POEM_LIBRARY.find(p => p.id === item.poemId);
        if (!poem) return '';
        return `<div class="home-card" onclick="openPoem('${poem.id}')" ondblclick="openReaderFromLibrary('${poem.id}')">
            <div class="home-card-title">${poem.title}</div>
            <div class="home-card-author">by ${poem.author}</div>
            <div class="home-card-stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
                ${item.note}
            </div>
        </div>`;
    }).join('');

    // Epigrams
    const epigramContainer = document.getElementById('epigram-poems');
    epigramContainer.innerHTML = EPIGRAMS.map(item => {
        const poem = POEM_LIBRARY.find(p => p.id === item.poemId);
        if (!poem) return '';
        return `<div class="home-card" onclick="openPoem('${poem.id}')" ondblclick="openReaderFromLibrary('${poem.id}')">
            <div class="home-card-title">${poem.title}</div>
            <div class="home-card-author">by ${poem.author}</div>
            <div class="home-card-stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                ${item.note}
            </div>
        </div>`;
    }).join('');
}

function readPoemOfDay() {
    if (poemOfDayCache) openReaderFromLibrary(poemOfDayCache.id);
}

// Handle click vs double-click for poem cards
let clickTimer = null;
let preventClick = false;

// Open poem modal (single click on home/library)
function openPoem(poemId) {
    if (preventClick) {
        preventClick = false;
        return;
    }
    if (clickTimer) clearTimeout(clickTimer);
    clickTimer = setTimeout(() => {
        openPoemModal(poemId);
    }, 200);
}

// Open full reader for library poems (double click or "Read Full Poem")
function openReaderFromLibrary(poemId) {
    // Cancel single-click timer on double-click
    if (clickTimer) {
        clearTimeout(clickTimer);
        clickTimer = null;
    }
    preventClick = true;
    // Reset after the click event finishes so it doesn't block future clicks
    setTimeout(() => { preventClick = false; }, 300);

    const poem = POEM_LIBRARY.find(p => p.id === poemId);
    if (!poem) return;
    currentReaderPoem = poem;

    document.getElementById('reader-poem-title').textContent = poem.title;
    document.getElementById('reader-title-display').textContent = poem.title;
    document.getElementById('reader-author-display').textContent = poem.author || 'Unknown';

    const stanzas = getStanzasWithMeta(poem);
    document.getElementById('reader-poem-text').innerHTML = stanzas.map(stanza => {
        const sectionHeader = stanza.sectionNumber ? `<div class="section-number">${stanza.sectionNumber}</div>` : '';
        const lines = stanza.lines.map(line => `<div class="poem-line">${line}</div>`).join('');
        return `<div class="stanza">${sectionHeader}${lines}</div>`;
    }).join('');

    document.getElementById('reader-container').classList.add('active');
    setupTextSelection();
}

async function addPoemOfDay() {
    try {
        if (!poemOfDayCache) {
            console.log('No poem of day cache');
            return;
        }

    const myPoems = await getMyPoems();
    if (myPoems.find(p => p.id === poemOfDayCache.id)) {
        showToast('Already Added', 'This poem is already in your collection');
        return;
    }

    const newPoem = {
        ...poemOfDayCache,
        currentStage: 1,
        lastStage: 1,
        completedStage6: false,
        successfulRecitations: 0,
        isMemorized: false,
        memorizedDate: null,
        lastReviewDate: null,
        nextReviewDate: null,
        reviewHistory: [],
        successfulReviews: 0,
        hintsUsed: 0,
        addedAt: Date.now(),
        isCustom: false,
        // Legacy fields for backward compatibility
        stage: 1,
        stageRepetition: 1,
        lastPracticed: null
    };

    await saveOnePoem(newPoem);
    showToast('Poem Added', `"${poemOfDayCache.title}" has been added to My Poems.`);
    } catch (error) {
        console.error('Error adding poem of day:', error);
        showToast('Error', 'Failed to add poem. Please try again.');
    }
}

// =====================================
// ADMIN PANEL FUNCTIONS
// =====================================

let adminAuthenticated = false;
let adminStaffPicks = []; // Local state for editing
let adminSettings = {}; // Cache of all settings

// Check URL hash for routes
function checkHashRoute() {
    if (window.location.hash === '#admin') {
        openAdmin();
    } else if (window.location.hash === '#support') {
        openLegalModal('support');
    }
}

function openAdmin() {
    document.getElementById('admin-panel').classList.add('active');
    if (adminAuthenticated) {
        showAdminDashboard();
    } else {
        document.getElementById('admin-login-view').style.display = 'block';
        document.getElementById('admin-dashboard').style.display = 'none';
    }
}

function closeAdmin() {
    document.getElementById('admin-panel').classList.remove('active');
    window.location.hash = '';
}

async function handleAdminLogin(e) {
    e.preventDefault();
    const password = document.getElementById('admin-password').value;
    const errorEl = document.getElementById('admin-login-error');

    // Require Supabase for admin authentication
    if (typeof verifyAdminPassword === 'function' && isSupabaseConfigured()) {
        try {
            const valid = await verifyAdminPassword(password);
            if (valid) {
                adminAuthenticated = true;
                errorEl.classList.remove('visible');
                await loadAdminSettings();
                showAdminDashboard();
            } else {
                errorEl.textContent = 'Invalid password';
                errorEl.classList.add('visible');
            }
        } catch (err) {
            errorEl.textContent = 'Authentication service unavailable';
            errorEl.classList.add('visible');
        }
    } else {
        errorEl.textContent = 'Admin authentication requires server configuration';
        errorEl.classList.add('visible');
    }
}

async function loadAdminSettings() {
    if (typeof getAllAppSettings === 'function' && isSupabaseConfigured()) {
        try {
            adminSettings = await getAllAppSettings();
        } catch (e) {
            console.error('Failed to load admin settings:', e);
            adminSettings = {};
        }
    }
}

function showAdminDashboard() {
    document.getElementById('admin-login-view').style.display = 'none';
    document.getElementById('admin-dashboard').style.display = 'block';
    document.getElementById('admin-password').value = '';

    // Populate poem selects
    populateAdminPoemSelects();

    // Load current Staff Picks
    loadStaffPicksEditor();

    // Load Monthly Challenge
    loadMonthlyChallenge();

    // Load POTD Override
    loadPotdOverride();

    // Render poem management list
    renderAdminPoemList();

    // Render collections management
    renderAdminCollections();
}

function populateAdminPoemSelects() {
    const monthlySelect = document.getElementById('admin-monthly-poem');
    const potdSelect = document.getElementById('admin-potd-poem');

    // Clear existing options (keep first)
    monthlySelect.innerHTML = '<option value="">-- Select a poem --</option>';
    potdSelect.innerHTML = '<option value="">-- No override (automatic) --</option>';

    // Add all poems
    POEM_LIBRARY.forEach(poem => {
        const option1 = document.createElement('option');
        option1.value = poem.id;
        option1.textContent = `${poem.title} - ${poem.author}`;
        monthlySelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = poem.id;
        option2.textContent = `${poem.title} - ${poem.author}`;
        potdSelect.appendChild(option2);
    });
}

// Staff Picks Editor
function loadStaffPicksEditor() {
    // Load from Supabase settings or fall back to hardcoded
    if (adminSettings.staff_picks) {
        adminStaffPicks = adminSettings.staff_picks;
    } else {
        // Initialize from hardcoded defaults
        adminStaffPicks = STAFF_PICKS.map(p => ({ poemId: p.poemId, note: p.note }));
    }
    renderStaffPicksList();
}

function renderStaffPicksList() {
    const container = document.getElementById('admin-staff-picks-list');

    if (adminStaffPicks.length === 0) {
        container.innerHTML = '<div class="admin-empty">No Staff Picks yet. Search and add poems below.</div>';
        return;
    }

    container.innerHTML = adminStaffPicks.map((pick, index) => {
        const poem = POEM_LIBRARY.find(p => p.id === pick.poemId);
        if (!poem) return '';
        return `<div class="admin-poem-item">
            <div class="order-btns">
                <button class="order-btn" onclick="moveStaffPick(${index}, -1)" ${index === 0 ? 'disabled' : ''}></button>
                <button class="order-btn" onclick="moveStaffPick(${index}, 1)" ${index === adminStaffPicks.length - 1 ? 'disabled' : ''}></button>
            </div>
            <div class="poem-info">
                <div class="poem-title">${poem.title}</div>
                <div class="poem-author">by ${poem.author}</div>
                <div class="poem-note">
                    <input type="text" value="${pick.note || ''}" placeholder="Add a note..." onchange="updateStaffPickNote(${index}, this.value)">
                </div>
            </div>
            <button class="remove-btn" onclick="removeStaffPick(${index})">Remove</button>
        </div>`;
    }).join('');
}

function moveStaffPick(index, direction) {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= adminStaffPicks.length) return;

    const temp = adminStaffPicks[index];
    adminStaffPicks[index] = adminStaffPicks[newIndex];
    adminStaffPicks[newIndex] = temp;
    renderStaffPicksList();
}

function updateStaffPickNote(index, note) {
    adminStaffPicks[index].note = note;
}

function removeStaffPick(index) {
    adminStaffPicks.splice(index, 1);
    renderStaffPicksList();
}

function addStaffPick(poemId) {
    if (adminStaffPicks.find(p => p.poemId === poemId)) {
        showToast('Already Added', 'This poem is already in Staff Picks');
        return;
    }
    adminStaffPicks.push({ poemId, note: '' });
    renderStaffPicksList();
    document.getElementById('admin-staff-search').value = '';
    document.getElementById('admin-staff-results').style.display = 'none';
}

function searchPoemsForAdmin(section) {
    const query = document.getElementById(`admin-${section}-search`).value.toLowerCase();
    const resultsEl = document.getElementById(`admin-${section}-results`);

    if (query.length < 2) {
        resultsEl.style.display = 'none';
        return;
    }

    const results = POEM_LIBRARY.filter(poem =>
        poem.title.toLowerCase().includes(query) ||
        poem.author.toLowerCase().includes(query)
    ).slice(0, 10);

    const existingIds = section === 'staff' ? adminStaffPicks.map(p => p.poemId) : [];

    resultsEl.innerHTML = results.map(poem => {
        const isAdded = existingIds.includes(poem.id);
        return `<div class="result-item ${isAdded ? 'added' : ''}">
            <div>
                <div style="font-weight:500;">${poem.title}</div>
                <div style="font-size:0.85rem;color:var(--text-muted);">by ${poem.author}</div>
            </div>
            ${isAdded ? '<span style="color:var(--text-muted);font-size:0.85rem;">Added</span>' : `<button class="add-btn" onclick="addStaffPick('${poem.id}')">Add</button>`}
        </div>`;
    }).join('');

    resultsEl.style.display = results.length > 0 ? 'block' : 'none';
}

async function saveStaffPicks() {
    if (typeof saveAppSetting === 'function' && isSupabaseConfigured()) {
        try {
            await saveAppSetting('staff_picks', adminStaffPicks);
            adminSettings.staff_picks = adminStaffPicks;

            // Update the in-memory STAFF_PICKS for immediate effect
            STAFF_PICKS.length = 0;
            adminStaffPicks.forEach(p => STAFF_PICKS.push(p));

            document.getElementById('staff-picks-saved').style.display = 'inline';
            setTimeout(() => document.getElementById('staff-picks-saved').style.display = 'none', 2000);
            showToast('Saved', 'Staff Picks updated successfully');
        } catch (e) {
            showToast('Error', 'Failed to save Staff Picks');
        }
    } else {
        showToast('Note', 'Supabase not configured. Changes saved locally only.');
        STAFF_PICKS.length = 0;
        adminStaffPicks.forEach(p => STAFF_PICKS.push(p));
        document.getElementById('staff-picks-saved').style.display = 'inline';
        setTimeout(() => document.getElementById('staff-picks-saved').style.display = 'none', 2000);
    }
}

// Monthly Challenge
function loadMonthlyChallenge() {
    const challenge = adminSettings.monthly_challenge;
    const display = document.getElementById('monthly-current-display');

    if (challenge && challenge.poem_id) {
        const poem = POEM_LIBRARY.find(p => p.id === challenge.poem_id);
        if (poem) {
            display.textContent = `${poem.title} (${challenge.month})`;
            document.getElementById('admin-monthly-poem').value = challenge.poem_id;
            document.getElementById('admin-monthly-month').value = challenge.month;
        }
    } else {
        display.textContent = 'None set';
    }
}

async function saveMonthlyChallenge() {
    const poemId = document.getElementById('admin-monthly-poem').value;
    const month = document.getElementById('admin-monthly-month').value;

    if (!poemId || !month) {
        showToast('Missing Info', 'Please select both a poem and month');
        return;
    }

    const challenge = { poem_id: poemId, month: month };

    if (typeof saveAppSetting === 'function' && isSupabaseConfigured()) {
        try {
            await saveAppSetting('monthly_challenge', challenge);
            adminSettings.monthly_challenge = challenge;
            loadMonthlyChallenge();
            document.getElementById('monthly-saved').style.display = 'inline';
            setTimeout(() => document.getElementById('monthly-saved').style.display = 'none', 2000);
            showToast('Saved', 'Monthly Challenge updated');
        } catch (e) {
            showToast('Error', 'Failed to save Monthly Challenge');
        }
    } else {
        showToast('Note', 'Supabase not configured');
    }
}

async function clearMonthlyChallenge() {
    if (typeof deleteAppSetting === 'function' && isSupabaseConfigured()) {
        try {
            await deleteAppSetting('monthly_challenge');
            delete adminSettings.monthly_challenge;
            document.getElementById('monthly-current-display').textContent = 'None set';
            document.getElementById('admin-monthly-poem').value = '';
            document.getElementById('admin-monthly-month').value = '';
            showToast('Cleared', 'Monthly Challenge removed');
        } catch (e) {
            showToast('Error', 'Failed to clear Monthly Challenge');
        }
    }
}

// POTD Override
function loadPotdOverride() {
    const override = adminSettings.potd_override;
    const display = document.getElementById('potd-current-display');

    if (override && override.poem_id) {
        const poem = POEM_LIBRARY.find(p => p.id === override.poem_id);
        if (poem) {
            display.textContent = `${poem.title} (${override.date})`;
            document.getElementById('admin-potd-poem').value = override.poem_id;
            document.getElementById('admin-potd-date').value = override.date;
        }
    } else {
        display.textContent = 'None (using automatic selection)';
    }
}

async function savePotdOverride() {
    const poemId = document.getElementById('admin-potd-poem').value;
    const date = document.getElementById('admin-potd-date').value;

    if (!poemId) {
        showToast('Missing Info', 'Please select a poem');
        return;
    }

    const override = { poem_id: poemId, date: date || new Date().toISOString().split('T')[0] };

    if (typeof saveAppSetting === 'function' && isSupabaseConfigured()) {
        try {
            await saveAppSetting('potd_override', override);
            adminSettings.potd_override = override;
            loadPotdOverride();
            document.getElementById('potd-saved').style.display = 'inline';
            setTimeout(() => document.getElementById('potd-saved').style.display = 'none', 2000);
            showToast('Saved', 'Poem of the Day override set');
        } catch (e) {
            showToast('Error', 'Failed to save override');
        }
    } else {
        showToast('Note', 'Supabase not configured');
    }
}

async function clearPotdOverride() {
    if (typeof deleteAppSetting === 'function' && isSupabaseConfigured()) {
        try {
            await deleteAppSetting('potd_override');
            delete adminSettings.potd_override;
            document.getElementById('potd-current-display').textContent = 'None (using automatic selection)';
            document.getElementById('admin-potd-poem').value = '';
            document.getElementById('admin-potd-date').value = '';
            showToast('Cleared', 'Override removed');
        } catch (e) {
            showToast('Error', 'Failed to clear override');
        }
    }
}

// =====================================
// ADMIN POEM MANAGEMENT
// =====================================

let adminPoemPage = 1;
const adminPoemsPerPage = 20;
let adminPoemFilter = '';
let parsedBulkPoems = [];

// Available themes for poem tagging
const AVAILABLE_THEMES = ['Nature', 'Love', 'Death', 'Time', 'Memory', 'Beauty', 'Freedom', 'Imagination', 'Childhood', 'Loss', 'Hope', 'Faith', 'Night', 'Dreams', 'Solitude', 'Art', 'History', 'Politics', 'Reflection'];

// =====================================
// COLLECTIONS MANAGEMENT
// =====================================

function switchAdminCollectionTab(tab) {
    const section = document.querySelector('.admin-section:has(#admin-collection-list-tab)');
    section.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    section.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');

    const tabMap = { 'list': 0, 'add': 1, 'manage': 2 };
    const tabs = section.querySelectorAll('.admin-tab');
    if (tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');

    document.getElementById(`admin-collection-${tab}-tab`).style.display = 'block';

    if (tab === 'list') renderAdminCollections();
    if (tab === 'add') initCollectionForm();
    if (tab === 'manage') initCollectionManage();
}

function renderAdminCollections() {
    const grid = document.getElementById('admin-collections-grid');
    grid.innerHTML = COLLECTIONS.map(c => {
        const poemCount = POEM_LIBRARY.filter(p => (p.collections || []).includes(c.id)).length;
        return `
        <div class="collection-admin-card" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:15px;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                <div>
                    <h4 style="margin:0;font-family:Georgia,serif;">${c.name}</h4>
                    <small style="color:var(--text-muted);">${poemCount} poems</small>
                </div>
                <div style="display:flex;gap:5px;">
                    <button class="btn btn-small" onclick="editCollection('${c.id}')" style="padding:4px 8px;font-size:0.75rem;">Edit</button>
                    <button class="btn btn-small delete-btn" onclick="confirmDeleteCollection('${c.id}')" style="padding:4px 8px;font-size:0.75rem;">Delete</button>
                </div>
            </div>
            <small style="color:var(--text-muted);font-family:monospace;">${c.id}</small>
        </div>`;
    }).join('') || '<p style="color:var(--text-muted);">No collections yet.</p>';
}

function initCollectionForm() {
    document.getElementById('admin-collection-name').value = '';
    document.getElementById('admin-collection-id').value = '';

    document.getElementById('admin-collection-name').oninput = function() {
        const name = this.value.trim();
        const id = name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-');
        document.getElementById('admin-collection-id').value = id;
    };
}

async function saveNewCollection() {
    const name = document.getElementById('admin-collection-name').value.trim();
    const id = document.getElementById('admin-collection-id').value.trim();

    if (!name || !id) {
        showToast('Missing Info', 'Collection name is required');
        return;
    }

    if (COLLECTIONS.find(c => c.id === id)) {
        showToast('Duplicate', 'A collection with this ID already exists');
        return;
    }

    try {
        await addCollection(id, name);
        COLLECTIONS.push({ id, name });
        showToast('Success', 'Collection created');
        switchAdminCollectionTab('list');
        renderCollections(); // Update main UI
    } catch (e) {
        showToast('Error', 'Failed to create collection: ' + e.message);
    }
}

function editCollection(collectionId) {
    const collection = COLLECTIONS.find(c => c.id === collectionId);
    if (!collection) return;

    const newName = prompt('Enter new name for collection:', collection.name);
    if (newName && newName.trim() && newName.trim() !== collection.name) {
        updateCollectionName(collectionId, newName.trim());
    }
}

async function updateCollectionName(collectionId, newName) {
    try {
        await updateCollection(collectionId, newName);
        const idx = COLLECTIONS.findIndex(c => c.id === collectionId);
        if (idx >= 0) COLLECTIONS[idx].name = newName;
        showToast('Success', 'Collection updated');
        renderAdminCollections();
        renderCollections(); // Update main UI
    } catch (e) {
        showToast('Error', 'Failed to update collection: ' + e.message);
    }
}

function confirmDeleteCollection(collectionId) {
    const collection = COLLECTIONS.find(c => c.id === collectionId);
    if (!collection) return;

    const poemCount = POEM_LIBRARY.filter(p => (p.collections || []).includes(collectionId)).length;
    const msg = poemCount > 0
        ? `Delete "${collection.name}"? This will remove ${poemCount} poems from this collection (poems won't be deleted).`
        : `Delete "${collection.name}"?`;

    if (confirm(msg)) {
        deleteCollectionAndCleanup(collectionId);
    }
}

async function deleteCollectionAndCleanup(collectionId) {
    try {
        // Remove collection from all poems that have it
        const poemsInCollection = POEM_LIBRARY.filter(p => (p.collections || []).includes(collectionId));
        for (const poem of poemsInCollection) {
            await removePoemFromCollection(poem.id, collectionId);
            poem.collections = (poem.collections || []).filter(c => c !== collectionId);
        }

        // Delete the collection
        await deleteCollection(collectionId);
        COLLECTIONS = COLLECTIONS.filter(c => c.id !== collectionId);

        showToast('Success', 'Collection deleted');
        renderAdminCollections();
        renderCollections(); // Update main UI
    } catch (e) {
        showToast('Error', 'Failed to delete collection: ' + e.message);
    }
}

function initCollectionManage() {
    const select = document.getElementById('admin-manage-collection-select');
    select.innerHTML = '<option value="">-- Select a collection --</option>' +
        COLLECTIONS.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    document.getElementById('admin-collection-poems').style.display = 'none';
}

function loadCollectionPoems() {
    const collectionId = document.getElementById('admin-manage-collection-select').value;
    const container = document.getElementById('admin-collection-poems');

    if (!collectionId) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    renderCollectionPoemList(collectionId);
}

function renderCollectionPoemList(collectionId) {
    const list = document.getElementById('admin-collection-poem-list');
    const poems = POEM_LIBRARY.filter(p => (p.collections || []).includes(collectionId));

    if (poems.length === 0) {
        list.innerHTML = '<p style="padding:15px;color:var(--text-muted);text-align:center;">No poems in this collection yet.</p>';
        return;
    }

    list.innerHTML = poems.map(p => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 15px;border-bottom:1px solid var(--border);">
            <div>
                <strong>${p.title}</strong>
                <small style="color:var(--text-muted);margin-left:10px;">${p.author}</small>
            </div>
            <button class="btn btn-small delete-btn" onclick="removePoemFromCollectionUI('${p.id}', '${collectionId}')" style="padding:4px 8px;font-size:0.75rem;">Remove</button>
        </div>
    `).join('');
}

async function removePoemFromCollectionUI(poemId, collectionId) {
    try {
        await removePoemFromCollection(poemId, collectionId);
        const poem = POEM_LIBRARY.find(p => p.id === poemId);
        if (poem) {
            poem.collections = (poem.collections || []).filter(c => c !== collectionId);
        }
        renderCollectionPoemList(collectionId);
        renderCollections(); // Update counts
        showToast('Removed', 'Poem removed from collection');
    } catch (e) {
        showToast('Error', 'Failed to remove poem: ' + e.message);
    }
}

function searchPoemsForCollection() {
    const query = document.getElementById('admin-collection-poem-search').value.toLowerCase().trim();
    const resultsContainer = document.getElementById('admin-collection-search-results');
    const collectionId = document.getElementById('admin-manage-collection-select').value;

    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const matches = POEM_LIBRARY.filter(p => {
        const inCollection = (p.collections || []).includes(collectionId);
        if (inCollection) return false; // Don't show poems already in collection
        return p.title.toLowerCase().includes(query) || p.author.toLowerCase().includes(query);
    }).slice(0, 20);

    if (matches.length === 0) {
        resultsContainer.innerHTML = '<p style="padding:15px;color:var(--text-muted);text-align:center;">No matching poems found.</p>';
    } else {
        resultsContainer.innerHTML = matches.map(p => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 15px;border-bottom:1px solid var(--border);">
                <div>
                    <strong>${p.title}</strong>
                    <small style="color:var(--text-muted);margin-left:10px;">${p.author}</small>
                </div>
                <button class="btn btn-small btn-primary" onclick="addPoemToCollectionUI('${p.id}', '${collectionId}')" style="padding:4px 8px;font-size:0.75rem;">Add</button>
            </div>
        `).join('');
    }
    resultsContainer.style.display = 'block';
}

async function addPoemToCollectionUI(poemId, collectionId) {
    try {
        await addPoemToCollection(poemId, collectionId);
        const poem = POEM_LIBRARY.find(p => p.id === poemId);
        if (poem) {
            poem.collections = poem.collections || [];
            poem.collections.push(collectionId);
        }
        renderCollectionPoemList(collectionId);
        searchPoemsForCollection(); // Refresh search results
        renderCollections(); // Update counts
        showToast('Poem Added', 'Poem added to My Poems.');
    } catch (e) {
        showToast('Error', 'Failed to add poem: ' + e.message);
    }
}

function switchAdminPoemTab(tab) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));

    const tabMap = { 'list': 0, 'add': 1, 'bulk': 2, 'edit': 3 };
    const tabs = document.querySelectorAll('.admin-tab');
    if (tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');

    document.getElementById(`admin-poem-${tab}-tab`).classList.add('active');

    if (tab === 'list') renderAdminPoemList();
    if (tab === 'add') initAdminPoemForm();
}

function initAdminPoemForm() {
    // Populate themes checkboxes
    const themesContainer = document.getElementById('admin-poem-themes');
    themesContainer.innerHTML = AVAILABLE_THEMES.map(t =>
        `<label class="checkbox-item"><input type="checkbox" value="${t}"> ${t}</label>`
    ).join('');

    // Populate collections checkboxes
    const collectionsContainer = document.getElementById('admin-poem-collections');
    collectionsContainer.innerHTML = COLLECTIONS.map(c =>
        `<label class="checkbox-item"><input type="checkbox" value="${c.id}"> ${c.name}</label>`
    ).join('');

    // Clear form
    document.getElementById('admin-poem-title').value = '';
    document.getElementById('admin-poem-author').value = '';
    document.getElementById('admin-poem-text').value = '';
    document.getElementById('admin-poem-popularity').value = '';
    document.getElementById('admin-poem-era').value = '';
    document.getElementById('admin-poem-preview').style.display = 'none';
}

function filterAdminPoemList() {
    adminPoemFilter = document.getElementById('admin-poem-search').value.toLowerCase();
    adminPoemPage = 1;
    renderAdminPoemList();
}

function renderAdminPoemList() {
    const tbody = document.getElementById('admin-poem-tbody');
    const countEl = document.getElementById('admin-poem-count');
    const paginationEl = document.getElementById('admin-poem-pagination');

    // Filter poems
    let poems = POEM_LIBRARY.filter(p => {
        if (!adminPoemFilter) return true;
        return p.title.toLowerCase().includes(adminPoemFilter) ||
               p.author.toLowerCase().includes(adminPoemFilter);
    });

    countEl.textContent = `${poems.length} poems found`;

    // Paginate
    const totalPages = Math.ceil(poems.length / adminPoemsPerPage);
    const start = (adminPoemPage - 1) * adminPoemsPerPage;
    const pagePoems = poems.slice(start, start + adminPoemsPerPage);

    // Render table
    tbody.innerHTML = pagePoems.map(poem => {
        const stanzaCount = poem.stanzas ? poem.stanzas.length : 0;
        return `<tr>
            <td>${poem.title}</td>
            <td>${poem.author}</td>
            <td>${stanzaCount}</td>
            <td class="actions">
                <button onclick="editAdminPoem('${poem.id}')">Edit</button>
                <button class="delete-btn" onclick="confirmDeletePoem('${poem.id}')">Delete</button>
            </td>
        </tr>`;
    }).join('');

    // Render pagination
    if (totalPages > 1) {
        let html = `<button onclick="adminPoemPage=1;renderAdminPoemList()" ${adminPoemPage === 1 ? 'disabled' : ''}>First</button>`;
        html += `<button onclick="adminPoemPage--;renderAdminPoemList()" ${adminPoemPage === 1 ? 'disabled' : ''}>Prev</button>`;
        html += `<span style="padding:8px;color:var(--text-muted);">Page ${adminPoemPage} of ${totalPages}</span>`;
        html += `<button onclick="adminPoemPage++;renderAdminPoemList()" ${adminPoemPage === totalPages ? 'disabled' : ''}>Next</button>`;
        html += `<button onclick="adminPoemPage=${totalPages};renderAdminPoemList()" ${adminPoemPage === totalPages ? 'disabled' : ''}>Last</button>`;
        paginationEl.innerHTML = html;
    } else {
        paginationEl.innerHTML = '';
    }
}

function generatePoemId(title, author) {
    const authorSlug = author.split(' ').pop().toLowerCase().replace(/[^a-z]/g, '');
    const titleSlug = title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-');
    return `${authorSlug}-${titleSlug}`;
}

function parseStanzas(text) {
    // Split by blank lines, then split each stanza by newlines
    // Remove leading/trailing whitespace and left-align
    return text.trim()
        .split(/\n\s*\n/)
        .map(stanza =>
            stanza.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
        )
        .filter(stanza => stanza.length > 0);
}

function getSelectedCheckboxes(containerId) {
    const container = document.getElementById(containerId);
    return Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
}

function previewAdminPoem() {
    const title = document.getElementById('admin-poem-title').value.trim();
    const author = document.getElementById('admin-poem-author').value.trim();
    const text = document.getElementById('admin-poem-text').value;

    if (!title || !author || !text) {
        showToast('Missing Info', 'Title, author, and text are required');
        return;
    }

    const stanzas = parseStanzas(text);
    const previewEl = document.getElementById('admin-poem-preview');

    previewEl.innerHTML = `
        <h4>${title} by ${author}</h4>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:15px;">${stanzas.length} stanzas, ${stanzas.flat().length} lines</p>
        ${stanzas.map(s => `<div class="stanza">${s.join('<br>')}</div>`).join('')}
    `;
    previewEl.style.display = 'block';
}

async function saveAdminPoem() {
    const title = document.getElementById('admin-poem-title').value.trim();
    const author = document.getElementById('admin-poem-author').value.trim();
    const text = document.getElementById('admin-poem-text').value;
    const popularity = document.getElementById('admin-poem-popularity').value;
    const era = document.getElementById('admin-poem-era').value;
    const themes = getSelectedCheckboxes('admin-poem-themes');
    const collections = getSelectedCheckboxes('admin-poem-collections');

    if (!title || !author || !text) {
        showToast('Missing Info', 'Title, author, and text are required');
        return;
    }

    const id = generatePoemId(title, author);
    const stanzas = parseStanzas(text);

    // Check if poem ID already exists
    if (POEM_LIBRARY.find(p => p.id === id)) {
        showToast('Duplicate', 'A poem with this ID already exists');
        return;
    }

    const poem = { id, title, author, stanzas, themes, popularity: popularity || null, era: era || null, collections };

    if (typeof addPoem === 'function' && isSupabaseConfigured()) {
        try {
            await addPoem(poem);
            POEM_LIBRARY.push(poem);
            setCachedPoems(POEM_LIBRARY);
            AUTHORS = [...new Set(POEM_LIBRARY.map(p => p.author))].sort();
            showToast('Success', 'Poem added to library');
            switchAdminPoemTab('list');
            populateAdminPoemSelects();
        } catch (e) {
            showToast('Error', 'Failed to save poem: ' + e.message);
        }
    } else {
        showToast('Error', 'Supabase not configured');
    }
}

function editAdminPoem(poemId) {
    const poem = POEM_LIBRARY.find(p => p.id === poemId);
    if (!poem) return;

    document.getElementById('admin-edit-poem-id').value = poemId;
    document.getElementById('admin-edit-title').value = poem.title;
    document.getElementById('admin-edit-author').value = poem.author;
    document.getElementById('admin-edit-text').value = poem.stanzas ? getStanzas(poem).map(s => s.join('\n')).join('\n\n') : '';
    document.getElementById('admin-edit-popularity').value = poem.popularity || '';
    document.getElementById('admin-edit-era').value = poem.era || '';

    // Populate themes checkboxes
    const themesContainer = document.getElementById('admin-edit-themes');
    themesContainer.innerHTML = AVAILABLE_THEMES.map(t =>
        `<label class="checkbox-item ${(poem.themes || []).includes(t) ? 'checked' : ''}">
            <input type="checkbox" value="${t}" ${(poem.themes || []).includes(t) ? 'checked' : ''}> ${t}
        </label>`
    ).join('');

    // Populate collections checkboxes
    const collectionsContainer = document.getElementById('admin-edit-collections');
    collectionsContainer.innerHTML = COLLECTIONS.map(c =>
        `<label class="checkbox-item ${(poem.collections || []).includes(c.id) ? 'checked' : ''}">
            <input type="checkbox" value="${c.id}" ${(poem.collections || []).includes(c.id) ? 'checked' : ''}> ${c.name}
        </label>`
    ).join('');

    switchAdminPoemTab('edit');
}

async function updateAdminPoem() {
    const poemId = document.getElementById('admin-edit-poem-id').value;
    const title = document.getElementById('admin-edit-title').value.trim();
    const author = document.getElementById('admin-edit-author').value.trim();
    const text = document.getElementById('admin-edit-text').value;
    const popularity = document.getElementById('admin-edit-popularity').value;
    const era = document.getElementById('admin-edit-era').value;
    const themes = getSelectedCheckboxes('admin-edit-themes');
    const collections = getSelectedCheckboxes('admin-edit-collections');

    if (!title || !author || !text) {
        showToast('Missing Info', 'Title, author, and text are required');
        return;
    }

    const stanzas = parseStanzas(text);
    const updates = { title, author, stanzas, themes, popularity: popularity || null, era: era || null, collections };

    if (typeof updatePoem === 'function' && isSupabaseConfigured()) {
        try {
            await updatePoem(poemId, updates);

            // Update local copy
            const idx = POEM_LIBRARY.findIndex(p => p.id === poemId);
            if (idx >= 0) {
                POEM_LIBRARY[idx] = { ...POEM_LIBRARY[idx], ...updates };
                setCachedPoems(POEM_LIBRARY);
            }

            AUTHORS = [...new Set(POEM_LIBRARY.map(p => p.author))].sort();
            showToast('Success', 'Poem updated');
            switchAdminPoemTab('list');
            populateAdminPoemSelects();
        } catch (e) {
            showToast('Error', 'Failed to update poem: ' + e.message);
        }
    } else {
        showToast('Error', 'Supabase not configured');
    }
}

function confirmDeletePoem(poemId) {
    const poem = POEM_LIBRARY.find(p => p.id === poemId);
    if (!poem) return;

    if (confirm(`Are you sure you want to delete "${poem.title}"? This cannot be undone.`)) {
        deleteAdminPoemById(poemId);
    }
}

async function deleteAdminPoem() {
    const poemId = document.getElementById('admin-edit-poem-id').value;
    const poem = POEM_LIBRARY.find(p => p.id === poemId);

    if (confirm(`Are you sure you want to delete "${poem?.title}"? This cannot be undone.`)) {
        await deleteAdminPoemById(poemId);
        switchAdminPoemTab('list');
    }
}

async function deleteAdminPoemById(poemId) {
    if (typeof deletePoem === 'function' && isSupabaseConfigured()) {
        try {
            await deletePoem(poemId);
            POEM_LIBRARY = POEM_LIBRARY.filter(p => p.id !== poemId);
            setCachedPoems(POEM_LIBRARY);
            AUTHORS = [...new Set(POEM_LIBRARY.map(p => p.author))].sort();
            showToast('Deleted', 'Poem removed from library');
            renderAdminPoemList();
            populateAdminPoemSelects();
        } catch (e) {
            showToast('Error', 'Failed to delete poem: ' + e.message);
        }
    } else {
        showToast('Error', 'Supabase not configured');
    }
}

// Bulk Import
function parseBulkPoems() {
    const text = document.getElementById('admin-bulk-text').value;
    const previewEl = document.getElementById('admin-bulk-preview');

    // Split by ---
    const blocks = text.split(/\n---\n/).filter(b => b.trim());

    parsedBulkPoems = blocks.map(block => {
        const lines = block.trim().split('\n');
        if (lines.length < 3) return null;

        const title = lines[0].trim();
        const author = lines[1].trim();
        const poemText = lines.slice(2).join('\n');
        const stanzas = parseStanzas(poemText);

        if (!title || !author || stanzas.length === 0) return null;

        return {
            id: generatePoemId(title, author),
            title,
            author,
            stanzas,
            themes: [],
            popularity: null,
            collections: []
        };
    }).filter(p => p !== null);

    // Check for duplicates
    parsedBulkPoems = parsedBulkPoems.filter(p => {
        const exists = POEM_LIBRARY.find(existing => existing.id === p.id);
        if (exists) {
            p.duplicate = true;
        }
        return true;
    });

    if (parsedBulkPoems.length === 0) {
        previewEl.innerHTML = '<div class="admin-empty">No valid poems found. Check the format.</div>';
        document.getElementById('bulk-import-btn').disabled = true;
        return;
    }

    previewEl.innerHTML = parsedBulkPoems.map((poem, i) => `
        <div class="admin-bulk-item" style="${poem.duplicate ? 'opacity:0.5;' : ''}">
            <h4>${poem.title}${poem.duplicate ? ' (already exists - will be skipped)' : ''}</h4>
            <p>by ${poem.author} | ${poem.stanzas.length} stanzas, ${poem.stanzas.flat().length} lines</p>
        </div>
    `).join('');

    const validPoems = parsedBulkPoems.filter(p => !p.duplicate);
    document.getElementById('bulk-import-btn').disabled = validPoems.length === 0;
    previewEl.innerHTML = `<p style="margin-bottom:15px;"><strong>${validPoems.length}</strong> new poems will be imported</p>` + previewEl.innerHTML;
}

async function importBulkPoems() {
    const validPoems = parsedBulkPoems.filter(p => !p.duplicate);

    if (validPoems.length === 0) {
        showToast('Nothing to Import', 'All poems already exist');
        return;
    }

    if (typeof bulkInsertPoems === 'function' && isSupabaseConfigured()) {
        try {
            await bulkInsertPoems(validPoems);

            // Add to local library
            POEM_LIBRARY.push(...validPoems);
            setCachedPoems(POEM_LIBRARY);
            AUTHORS = [...new Set(POEM_LIBRARY.map(p => p.author))].sort();

            showToast('Success', `${validPoems.length} poems imported`);
            document.getElementById('admin-bulk-text').value = '';
            document.getElementById('admin-bulk-preview').innerHTML = '';
            document.getElementById('bulk-import-btn').disabled = true;
            parsedBulkPoems = [];
            populateAdminPoemSelects();
        } catch (e) {
            showToast('Error', 'Failed to import poems: ' + e.message);
        }
    } else {
        showToast('Error', 'Supabase not configured');
    }
}

// Listen for hash changes
window.addEventListener('hashchange', checkHashRoute);

function toggleTheme() { const s = getSettings(); s.darkMode = !s.darkMode; saveSettings(s); applyTheme(); }
function applyTheme() {
    const isDark = getSettings().darkMode;
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

    // Update status bar on mobile
    if (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform()) {
        const StatusBar = window.Capacitor.Plugins.StatusBar;
        const bgColor = isDark ? '#1a1612' : '#f5f0e6';

        if (StatusBar) {
            StatusBar.setStyle({ style: isDark ? 'DARK' : 'LIGHT' });
            if (window.Capacitor.getPlatform() !== 'ios') {
                StatusBar.setBackgroundColor({ color: bgColor });
            }
        }

        // Update native iOS webview background color for overscroll areas
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.themeChange) {
            window.webkit.messageHandlers.themeChange.postMessage({ color: bgColor });
        }
    }
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    if (tabName === 'home') renderHome();
    if (tabName === 'library') { displayedCount = 20; filterLibrary(); }
    if (tabName === 'my-poems') renderMyPoems();
    if (tabName === 'quotes') renderQuotes();
    if (tabName === 'progress') renderProgress();
}

function getAllLines(poem) {
    if (poem.stanzas) {
        // Handle both formats: array of arrays OR array of {sectionNumber, lines} objects
        return poem.stanzas.flatMap(s => Array.isArray(s) ? s : (s.lines || []));
    }
    return poem.text.trim().split(/\n/).filter(l => l.trim());
}

function getStanzas(poem) {
    if (poem.stanzas) {
        // Normalize to array of arrays for backward compatibility
        return poem.stanzas.map(s => Array.isArray(s) ? s : (s.lines || []));
    }
    return poem.text.trim().split(/\n\s*\n/).map(s => s.split('\n').filter(l => l.trim()));
}

// Get stanzas with section metadata (for display purposes)
function getStanzasWithMeta(poem) {
    if (!poem.stanzas) {
        return poem.text.trim().split(/\n\s*\n/).map(s => ({
            sectionNumber: null,
            lines: s.split('\n').filter(l => l.trim())
        }));
    }
    return poem.stanzas.map(s => {
        if (Array.isArray(s)) {
            return { sectionNumber: null, lines: s };
        }
        return { sectionNumber: s.sectionNumber || null, lines: s.lines || [] };
    });
}

// LocalStorage cache for poems
const POEMS_CACHE_KEY = 'mnemosyne_poems_cache';
const POEMS_CACHE_TIME_KEY = 'mnemosyne_poems_cache_time';
const CACHE_MAX_AGE = 1000 * 60 * 60; // 1 hour

function getCachedPoems() {
    try {
        const cached = localStorage.getItem(POEMS_CACHE_KEY);
        const cacheTime = localStorage.getItem(POEMS_CACHE_TIME_KEY);
        if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            if (age < CACHE_MAX_AGE) {
                return JSON.parse(cached);
            }
        }
    } catch (e) { /* ignore cache errors */ }
    return null;
}

function setCachedPoems(poems) {
    try {
        localStorage.setItem(POEMS_CACHE_KEY, JSON.stringify(poems));
        localStorage.setItem(POEMS_CACHE_TIME_KEY, Date.now().toString());
    } catch (e) { /* ignore cache errors */ }
}

// Load all data files
async function loadLibrary() {
    const container = document.getElementById('library-poems');
    container.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p class="loading-text">Loading poetry library...</p></div>`;

    try {
        // Try to fetch poems from Supabase first
        let poemsFromSupabase = false;

        if (typeof fetchAllPoems === 'function' && isSupabaseConfigured()) {
            try {
                const supabasePoems = await fetchAllPoems();
                if (supabasePoems && supabasePoems.length > 0) {
                    POEM_LIBRARY = supabasePoems;
                    poemsFromSupabase = true;
                    setCachedPoems(supabasePoems); // Update cache
                    console.log(`Loaded ${supabasePoems.length} poems from Supabase`);
                }
            } catch (e) {
                console.warn('Failed to fetch from Supabase, trying cache/fallback:', e);
            }
        }

        // If Supabase failed, try localStorage cache
        if (!poemsFromSupabase) {
            const cachedPoems = getCachedPoems();
            if (cachedPoems && cachedPoems.length > 0) {
                POEM_LIBRARY = cachedPoems;
                console.log(`Loaded ${cachedPoems.length} poems from cache`);
            } else {
                // Last resort: load from static JSON
                const poemsRes = await fetch('poems.json');
                if (!poemsRes.ok) throw new Error('Failed to load poems');
                POEM_LIBRARY = await poemsRes.json();
                console.log(`Loaded ${POEM_LIBRARY.length} poems from poems.json`);
            }
        }

        // Load collections from Supabase first, fallback to JSON
        if (typeof fetchAllCollections === 'function') {
            const supabaseCollections = await fetchAllCollections();
            if (supabaseCollections && supabaseCollections.length > 0) {
                COLLECTIONS = supabaseCollections;
                console.log(`Loaded ${COLLECTIONS.length} collections from Supabase`);
            } else {
                // Fallback to JSON
                const collectionsRes = await fetch('collections.json');
                if (collectionsRes.ok) {
                    const data = await collectionsRes.json();
                    COLLECTIONS = data.collections || [];
                    console.log(`Loaded ${COLLECTIONS.length} collections from JSON (fallback)`);
                }
            }
        } else {
            const collectionsRes = await fetch('collections.json');
            if (collectionsRes.ok) {
                const data = await collectionsRes.json();
                COLLECTIONS = data.collections || [];
            }
        }

        // Try to load search index (optional)
        try {
            const searchRes = await fetch('search-index.json');
            if (searchRes.ok) SEARCH_INDEX = await searchRes.json();
        } catch (e) { /* search index optional */ }

        AUTHORS = [...new Set(POEM_LIBRARY.map(p => p.author))].sort();
        libraryLoaded = true;

        renderHome();
        renderCollections();
        renderThemeTags();
        setupSearchListeners();
        filterLibrary();
    } catch (error) {
        container.innerHTML = `
            <div class="error-state">
                <h3>Could not load poems</h3>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="loadLibrary()">Try Again</button>
            </div>`;
    }
}

function renderCollections() {
    const grid = document.getElementById('collections-grid');
    grid.innerHTML = COLLECTIONS.map(c => {
        // Count poems that belong to this collection dynamically
        const poemCount = POEM_LIBRARY.filter(p => (p.collections || []).includes(c.id)).length;
        return `
        <div class="collection-card ${activeCollection === c.id ? 'active' : ''}" onclick="selectCollection('${c.id}')">
            <h4>${c.name}</h4>
            <div class="coll-count">${poemCount} poems</div>
        </div>`;
    }).join('');
}

function renderThemeTags() {
    const container = document.getElementById('theme-tags');
    const themeCounts = {};
    AVAILABLE_THEMES.forEach(t => { themeCounts[t] = 0; });
    POEM_LIBRARY.forEach(p => {
        (p.themes || []).forEach(t => { if (themeCounts[t] !== undefined) themeCounts[t]++; });
    });
    container.innerHTML = AVAILABLE_THEMES.map(t => `
        <span class="theme-tag ${activeTheme === t ? 'active' : ''}" onclick="selectTheme('${t}')">${t}${themeCounts[t] ? `<span class="tag-count">(${themeCounts[t]})</span>` : ''}</span>
    `).join('');
}

function selectTheme(name) {
    activeTheme = activeTheme === name ? null : name;
    activeCollection = null;
    displayedCount = 20;
    renderCollections();
    renderThemeTags();
    filterLibrary();
}

function selectCollection(id) {
    activeCollection = activeCollection === id ? null : id;
    activeTheme = null;
    displayedCount = 20;
    renderCollections();
    renderThemeTags();
    filterLibrary();
}

function clearFilters() {
    activeCollection = null;
    activeTheme = null;
    document.getElementById('library-search').value = '';
    document.getElementById('era-filter').value = '';
    document.getElementById('popularity-filter').value = '';
    displayedCount = 20;
    renderCollections();
    renderThemeTags();
    filterLibrary();
}


function handleSearch() {
    displayedCount = 20;
    filterLibrary();
}

let lastSearchValue = '';

function setupSearchListeners() {
    const searchInput = document.getElementById('library-search');
    if (!searchInput) return;

    // Multiple events for Android compatibility
    ['input', 'keyup', 'keydown', 'change', 'search', 'focus', 'blur'].forEach(eventType => {
        searchInput.addEventListener(eventType, handleSearch);
    });

    // Polling fallback for Android - check every 300ms if value changed
    setInterval(() => {
        const currentValue = searchInput.value;
        if (currentValue !== lastSearchValue) {
            lastSearchValue = currentValue;
            handleSearch();
        }
    }, 300);
}

function filterLibrary() {
    if (!libraryLoaded) return;

    const search = document.getElementById('library-search').value.toLowerCase().trim();
    const era = document.getElementById('era-filter').value;
    const popularity = document.getElementById('popularity-filter').value;

    // Get poems from active collection or theme
    let poemPool = POEM_LIBRARY;

    if (activeCollection) {
        poemPool = POEM_LIBRARY.filter(p => (p.collections || []).includes(activeCollection));
    } else if (activeTheme) {
        poemPool = POEM_LIBRARY.filter(p => (p.themes || []).includes(activeTheme));
    }

    filteredPoems = poemPool.filter(poem => {
        try {
            if (era && poem.era !== era) return false;
            if (popularity && poem.popularity !== popularity) return false;
            if (search) {
                // Search in title, author
                if (poem.title && poem.title.toLowerCase().includes(search)) return true;
                if (poem.author && poem.author.toLowerCase().includes(search)) return true;
                // Search in all lines using getStanzas for compatibility
                const stanzas = getStanzas(poem);
                if (stanzas.some(stanza => stanza.some(line => line.toLowerCase().includes(search)))) return true;
                // Search in themes
                if (poem.themes && poem.themes.some(t => t.toLowerCase().includes(search))) return true;
                return false;
            }
            return true;
        } catch (e) {
            console.error('Filter error for poem:', poem.id, e);
            return false;
        }
    });

    renderLibrary();
}

async function renderLibrary() {
    const container = document.getElementById('library-poems');
    const label = activeCollection ? COLLECTIONS.find(c => c.id === activeCollection)?.name :
                  activeTheme ? activeTheme : 'all poems';
    const myPoems = await getMyPoems();
    const myPoemIds = new Set(myPoems.map(p => p.id));

    document.getElementById('library-stats').textContent = `Showing ${Math.min(displayedCount, filteredPoems.length)} of ${filteredPoems.length} ${label}`;

    if (filteredPoems.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No poems found</h3><p>Try different filters or search terms</p></div>';
        document.getElementById('load-more-btn').style.display = 'none';
        return;
    }

    container.innerHTML = filteredPoems.slice(0, displayedCount).map(poem => {
        const stanzas = getStanzas(poem);
        const lineCount = stanzas.flat().length;
        const firstLine = (stanzas[0] && stanzas[0][0]) || '';
        const isAdded = myPoemIds.has(poem.id);
        return `
        <div class="poem-card" onclick="openPoemModal('${poem.id}')" style="position: relative; padding-bottom: 50px;">
            ${poem.popularity === 'high' ? '<span class="popularity-badge high">Famous</span>' : ''}
            <h3>${poem.title}</h3>
            <p class="author">${poem.author}</p>
            <p class="preview">${firstLine}...</p>
            <div class="meta">
                <span class="line-count">${lineCount} lines</span>
                ${(poem.themes || []).filter(t => t.toLowerCase() !== 'spirituality').slice(0, 2).map(t => `<span class="poem-theme">${t}</span>`).join('')}
            </div>
            <button class="btn ${isAdded ? 'btn-secondary' : 'btn-primary'} btn-small library-add-btn" onclick="event.stopPropagation(); ${isAdded ? '' : `addPoemFromLibrary('${poem.id}')`}" style="position: absolute; bottom: 15px; right: 15px;${isAdded ? ' opacity: 0.6; cursor: default;' : ''}">${isAdded ? 'Added' : 'Add to My Poems'}</button>
        </div>`;
    }).join('');

    document.getElementById('load-more-btn').style.display = displayedCount < filteredPoems.length ? 'block' : 'none';
}

function loadMorePoems() { displayedCount += 20; renderLibrary(); }

function getPoemStatusLabel(poem) {
    const p = migratePoem(poem);
    if (p.isMemorized) {
        if (p.successfulReviews >= 5) return 'Mastered';
        return `Memorized - ${getReviewDueText(p)}`;
    }
    if (p.completedStage6) {
        return `Recitation practice - ${p.successfulRecitations || 0}/3`;
    }
    return `Learning - Stage ${p.lastStage || 1}/6`;
}

function getPoemProgress(poem) {
    const p = migratePoem(poem);
    if (p.isMemorized) {
        // After memorization, progress is based on review count (5 reviews = mastered)
        return Math.min(100, 70 + (p.successfulReviews || 0) * 6);
    }
    if (p.completedStage6) {
        // Completed stage 6, working on recitations (3 needed)
        return 60 + ((p.successfulRecitations || 0) / 3) * 10;
    }
    // Learning stages 1-6
    return Math.min(60, ((p.lastStage || 1) / 7) * 60);
}

async function renderMyPoems() {
    const container = document.getElementById('my-poems-list');
    const myPoems = await getMyPoems();
    if (myPoems.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No poems yet</h3><p>Add poems from the library or create your own</p></div>';
        return;
    }
    container.innerHTML = myPoems.map(poem => {
        const p = migratePoem(poem);
        const progress = getPoemProgress(p);
        const stageLabel = getPoemStatusLabel(p);
        const isDue = isReviewDue(p);
        const poemStanzas = getStanzas(p);
        const firstLine = (poemStanzas[0] && poemStanzas[0][0]) || '';
        const buttonText = p.isMemorized ? 'Review' : (p.completedStage6 ? 'Practice' : 'Learn');
        return `<div class="poem-card">
            ${isDue ? '<span class="badge">Due for Review</span>' : ''}
            <h3>${p.title}</h3>
            <p class="author">${p.author || 'Unknown'}</p>
            <p class="preview">${firstLine}...</p>
            <div class="progress-bar-container"><div class="progress-bar" style="width: ${progress}%"></div></div>
            <p class="stage-label">${stageLabel}</p>
            <div class="card-actions" style="justify-content: space-between;">
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); startLearning('${p.id}')">${buttonText}</button>
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openReader('${p.id}')">Read</button>
                </div>
                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); removePoem('${p.id}')">Remove</button>
            </div>
        </div>`;
    }).join('');
}

function isReviewDue(poem) {
    const p = migratePoem(poem);
    if (!p.isMemorized) return false;
    if (!p.nextReviewDate) return true;
    return Date.now() >= p.nextReviewDate;
}

function calculateNextReviewDate(successfulReviews) {
    const idx = Math.min(successfulReviews, REVIEW_INTERVALS.length - 1);
    return Date.now() + (REVIEW_INTERVALS[idx] * 86400000);
}

function getReviewDueText(poem) {
    const p = migratePoem(poem);
    if (!p.nextReviewDate) return 'Review now';
    const now = Date.now();
    if (now >= p.nextReviewDate) return 'Review due';
    const daysLeft = Math.ceil((p.nextReviewDate - now) / 86400000);
    if (daysLeft === 1) return 'Review tomorrow';
    return `Review in ${daysLeft} days`;
}

async function renderProgress() {
    const myPoems = await getMyPoems();
    const migratedPoems = myPoems.map(migratePoem);

    document.getElementById('stat-memorized').textContent = migratedPoems.filter(p => p.isMemorized).length;
    document.getElementById('stat-lines').textContent = migratedPoems.reduce((sum, p) => sum + getAllLines(p).length, 0);
    document.getElementById('stat-in-progress').textContent = migratedPoems.filter(p => !p.isMemorized).length;

    renderAchievements();

    const duePoems = migratedPoems.filter(isReviewDue);
    document.getElementById('due-review-list').innerHTML = duePoems.length === 0
        ? '<div class="empty-state"><h3>All caught up!</h3><p>No poems due for review</p></div>'
        : duePoems.map(p => `<div class="poem-card"><span class="badge">Due</span><h3>${p.title}</h3><p class="author">${p.author}</p><div class="card-actions"><button class="btn btn-primary btn-small" onclick="startPractice('${p.id}')">Review</button></div></div>`).join('');
}

async function openPoemModal(poemId) {
    const poem = POEM_LIBRARY.find(p => p.id === poemId);
    if (!poem) return;
    currentModalPoem = poem;
    document.getElementById('modal-title').textContent = poem.title;
    document.getElementById('modal-author').textContent = poem.author;

    // Build metadata
    const meta = [];
    if (poem.popularity === 'high') meta.push('Famous');
    if (poem.themes) poem.themes.filter(t => t.toLowerCase() !== 'spirituality').forEach(t => meta.push(t));
    document.getElementById('modal-meta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');

    const stanzas = getStanzasWithMeta(poem);
    document.getElementById('modal-poem-text').innerHTML = stanzas.map(s => {
        const sectionHeader = s.sectionNumber ? `<div class="section-number">${s.sectionNumber}</div>` : '';
        return `<div class="stanza">${sectionHeader}${s.lines.join('<br>')}</div>`;
    }).join('');
    const myPoems = await getMyPoems();
    document.getElementById('modal-add-btn').style.display = myPoems.some(p => p.id === poem.id) ? 'none' : 'inline-block';
    document.getElementById('poem-modal').classList.add('active');
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); currentModalPoem = null; }

async function addToMyPoems() {
    const myPoems = await getMyPoems();
    if (!currentModalPoem || myPoems.some(p => p.id === currentModalPoem.id)) { closeModal('poem-modal'); return; }
    const newPoem = {
        ...currentModalPoem,
        currentStage: 1,
        lastStage: 1,
        completedStage6: false,
        successfulRecitations: 0,
        isMemorized: false,
        memorizedDate: null,
        lastReviewDate: null,
        nextReviewDate: null,
        reviewHistory: [],
        successfulReviews: 0,
        hintsUsed: 0,
        addedAt: Date.now(),
        // Legacy fields for backward compatibility
        stage: 1,
        stageRepetition: 1,
        lastPracticed: null
    };
    await saveOnePoem(newPoem);
    const title = currentModalPoem.title;
    closeModal('poem-modal');
    showToast('Poem Added', `"${title}" has been added to My Poems.`);
}

async function addPoemFromLibrary(poemId) {
    const poem = POEM_LIBRARY.find(p => p.id === poemId);
    if (!poem) return;
    const myPoems = await getMyPoems();
    if (myPoems.some(p => p.id === poem.id)) {
        showToast('Already Added', `"${poem.title}" is already in your collection.`);
        return;
    }
    const newPoem = {
        ...poem,
        currentStage: 1,
        lastStage: 1,
        completedStage6: false,
        successfulRecitations: 0,
        isMemorized: false,
        memorizedDate: null,
        lastReviewDate: null,
        nextReviewDate: null,
        reviewHistory: [],
        successfulReviews: 0,
        hintsUsed: 0,
        addedAt: Date.now(),
        // Legacy fields for backward compatibility
        stage: 1,
        stageRepetition: 1,
        lastPracticed: null
    };
    await saveOnePoem(newPoem);
    showToast('Poem Added', `"${poem.title}" has been added to My Poems.`);
    renderLibrary();
}

function toggleAddPoemSection() { document.getElementById('add-poem-section').classList.toggle('collapsed'); }
function formatText(type) { const ta = document.getElementById('custom-text'); const s = ta.selectionStart, e = ta.selectionEnd, sel = ta.value.substring(s, e); ta.value = ta.value.substring(0, s) + (type === 'italic' ? `*${sel}*` : type === 'bold' ? `**${sel}**` : `    ${sel}`) + ta.value.substring(e); ta.focus(); }

async function saveCustomPoem() {
    const title = document.getElementById('custom-title').value.trim();
    const author = document.getElementById('custom-author').value.trim();
    const text = document.getElementById('custom-text').value.trim();
    if (!title || !text) { alert('Please enter title and text'); return; }

    const stanzas = text.split(/\n\s*\n/).map(s => s.split('\n').filter(l => l.trim()));

    const newPoem = {
        id: 'custom_' + Date.now(),
        title,
        author: author || 'Unknown',
        stanzas,
        text,
        currentStage: 1,
        lastStage: 1,
        completedStage6: false,
        successfulRecitations: 0,
        isMemorized: false,
        memorizedDate: null,
        lastReviewDate: null,
        nextReviewDate: null,
        reviewHistory: [],
        successfulReviews: 0,
        hintsUsed: 0,
        addedAt: Date.now(),
        isCustom: true,
        // Legacy fields for backward compatibility
        stage: 1,
        stageRepetition: 1,
        lastPracticed: null
    };
    await saveOnePoem(newPoem);
    document.getElementById('custom-title').value = '';
    document.getElementById('custom-author').value = '';
    document.getElementById('custom-text').value = '';
    document.getElementById('add-poem-section').classList.add('collapsed');
    renderMyPoems();
}

let pendingRemovePoemId = null;
function removePoem(id) { pendingRemovePoemId = id; openModal('remove-poem-modal'); }
async function confirmRemovePoem() { if (pendingRemovePoemId) { await removeOnePoemFromStorage(pendingRemovePoemId); pendingRemovePoemId = null; renderMyPoems(); } }

// Reader functionality
let currentReaderPoem = null;
let selectedText = '';
let selectionRange = null;

async function openReader(poemId) {
    const myPoems = await getMyPoems();
    const poem = myPoems.find(p => p.id === poemId);
    if (!poem) return;
    currentReaderPoem = poem;

    document.getElementById('reader-poem-title').textContent = poem.title;
    document.getElementById('reader-title-display').textContent = poem.title;
    document.getElementById('reader-author-display').textContent = poem.author || 'Unknown';

    const stanzas = getStanzasWithMeta(poem);
    document.getElementById('reader-poem-text').innerHTML = stanzas.map(stanza => {
        const sectionHeader = stanza.sectionNumber ? `<div class="section-number">${stanza.sectionNumber}</div>` : '';
        const lines = stanza.lines.map(line => `<div class="poem-line">${line}</div>`).join('');
        return `<div class="stanza">${sectionHeader}${lines}</div>`;
    }).join('');

    document.getElementById('reader-container').classList.add('active');
    setupTextSelection();
}

function closeReader() {
    document.getElementById('reader-container').classList.remove('active');
    hideHighlightTip();
    currentReaderPoem = null;
}



let selectionTimeout = null;

function setupTextSelection() {
    const readerText = document.getElementById('reader-poem-text');

    // Prevent native context menu on poem text (mobile copy/share menu)
    readerText.addEventListener('contextmenu', (e) => e.preventDefault());

    // Desktop: mouseup works fine
    readerText.addEventListener('mouseup', handleTextSelection);

    // Mobile: only show popup on touchend (finger lift) so users can
    // finish adjusting their selection before the modal appears
    let isTouching = false;

    readerText.addEventListener('touchstart', () => {
        isTouching = true;
        clearTimeout(selectionTimeout);
    });

    readerText.addEventListener('touchend', () => {
        isTouching = false;
        if (document.getElementById('quote-popup').classList.contains('visible')) return;

        // Short delay to let the selection finalize after finger lifts
        clearTimeout(selectionTimeout);
        selectionTimeout = setTimeout(() => {
            const selection = window.getSelection();
            const text = selection ? selection.toString().trim() : '';
            if (text.length > 0 && selection.anchorNode && readerText.contains(selection.anchorNode)) {
                handleTextSelection();
            }
        }, 300);
    });

    readerText.addEventListener('touchcancel', () => {
        isTouching = false;
        clearTimeout(selectionTimeout);
    });
}

function handleTextSelection() {
    try {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;

        const text = selection.toString().trim();
        if (text.length === 0) return;

        // Try to get text with stanza breaks preserved
        const range = selection.getRangeAt(0);
        const formattedText = getSelectionWithStanzaBreaks(range, text);

        selectedText = formattedText;
        selectionRange = range;
        showQuotePopup(formattedText);
    } catch (e) {
        console.error('Selection error:', e);
    }
}

function getSelectionWithStanzaBreaks(range, fallbackText) {
    try {
        const container = document.getElementById('reader-poem-text');
        if (!container) return fallbackText;

        // Get all stanzas that intersect with the selection
        const stanzas = container.querySelectorAll('.stanza');
        const selectedStanzas = [];

        for (const stanza of stanzas) {
            if (range.intersectsNode(stanza)) {
                const lines = stanza.querySelectorAll('.poem-line');
                const stanzaLines = [];

                for (const line of lines) {
                    if (range.intersectsNode(line)) {
                        // Check if selection contains this line's text
                        const lineText = line.textContent;
                        if (fallbackText.includes(lineText)) {
                            stanzaLines.push(lineText);
                        } else {
                            // Partial line - extract what we can
                            const sel = window.getSelection();
                            if (sel && sel.toString().includes(lineText.substring(0, 10))) {
                                stanzaLines.push(lineText);
                            }
                        }
                    }
                }

                if (stanzaLines.length > 0) {
                    selectedStanzas.push(stanzaLines.join('\n'));
                }
            }
        }

        // If we got stanzas, join with blank lines; otherwise use fallback
        if (selectedStanzas.length > 0) {
            return selectedStanzas.join('\n\n');
        }
        return fallbackText;
    } catch (e) {
        console.error('Stanza extraction error:', e);
        return fallbackText;
    }
}

function showQuotePopup(text) {
    document.getElementById('quote-popup-text').textContent = text;
    document.getElementById('quote-popup-overlay').classList.add('visible');
    document.getElementById('quote-popup').classList.add('visible');
    // Clear native selection to hide mobile selection handles and menu
    window.getSelection().removeAllRanges();
}

function hideQuotePopup() {
    document.getElementById('quote-popup-overlay').classList.remove('visible');
    document.getElementById('quote-popup').classList.remove('visible');
    window.getSelection().removeAllRanges();
    selectedText = '';
    selectionRange = null;
}

function copySelectedText() {
    if (!selectedText) return;
    navigator.clipboard.writeText(selectedText).then(() => {
        showToast('Copied', '');
        hideQuotePopup();
    }).catch(() => {
        showToast('Copy failed', '');
    });
}

async function saveQuoteFromSelection() {
    if (!selectedText || !currentReaderPoem) return;

    const quote = {
        id: 'quote_' + Date.now(),
        text: selectedText,
        poemTitle: currentReaderPoem.title,
        author: currentReaderPoem.author || 'Unknown',
        poemId: currentReaderPoem.id,
        savedAt: new Date().toISOString()
    };

    await saveQuote(quote);
    hideQuotePopup();
    showToast('Quote Saved', '');
}

// Quotes storage - uses Supabase when logged in, localStorage otherwise
// Note: userQuotesCache is declared in supabase.js

function getLocalQuotes() {
    const stored = localStorage.getItem('mnemosyne_quotes');
    return stored ? JSON.parse(stored) : [];
}

function saveLocalQuotes(quotes) {
    localStorage.setItem('mnemosyne_quotes', JSON.stringify(quotes));
}

async function getQuotes() {
    // Use Supabase if logged in
    if (currentUser && typeof fetchUserQuotes === 'function') {
        if (userQuotesCache) return userQuotesCache;
        try {
            userQuotesCache = await fetchUserQuotes(currentUser.id);
            return userQuotesCache;
        } catch (e) {
            console.error('Error fetching quotes from Supabase:', e);
            return getLocalQuotes();
        }
    }
    return getLocalQuotes();
}

async function saveQuote(quote) {
    // Get existing quotes and add new one
    const quotes = await getQuotes();
    quotes.unshift(quote);

    // Always save locally as backup
    saveLocalQuotes(quotes);

    // If logged in, also save to Supabase
    if (currentUser && typeof saveUserQuote === 'function') {
        try {
            await saveUserQuote(currentUser.id, quote);
            userQuotesCache = quotes;
        } catch (e) {
            console.error('Error saving quote to Supabase:', e);
        }
    }
}

let pendingDeleteQuoteId = null;

function deleteQuote(quoteId) {
    pendingDeleteQuoteId = quoteId;
    openModal('delete-quote-modal');
}

async function confirmDeleteQuote() {
    if (!pendingDeleteQuoteId) return;
    const quoteId = pendingDeleteQuoteId;
    pendingDeleteQuoteId = null;

    let quotes = await getQuotes();
    quotes = quotes.filter(q => q.id !== quoteId);

    // Always update localStorage
    saveLocalQuotes(quotes);

    // If logged in, also delete from Supabase
    if (currentUser && typeof deleteUserQuote === 'function') {
        try {
            await deleteUserQuote(currentUser.id, quoteId);
            userQuotesCache = quotes;
        } catch (e) {
            console.error('Error deleting quote from Supabase:', e);
        }
    }

    renderQuotes();
}

async function renderQuotes(searchQuery = '') {
    const container = document.getElementById('quotes-list');
    const allQuotes = await getQuotes();

    document.getElementById('quotes-count').textContent = `(${allQuotes.length})`;

    if (allQuotes.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No quotes saved yet</h3><p>Open a poem in the reader and select text to save quotes</p></div>';
        return;
    }

    const query = searchQuery.toLowerCase().trim();
    const quotes = query ? allQuotes.filter(q =>
        q.text.toLowerCase().includes(query) ||
        q.poemTitle.toLowerCase().includes(query) ||
        q.author.toLowerCase().includes(query)
    ) : allQuotes;

    if (quotes.length === 0) {
        container.innerHTML = `<div class="empty-state"><h3>No matches found</h3><p>No quotes match "${searchQuery}"</p></div>`;
        return;
    }

    container.innerHTML = quotes.map(quote => {
        const savedDate = new Date(quote.savedAt);
        const date = savedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const escapedText = quote.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const escapedId = quote.id.replace(/'/g, "\\'");
        return `<div class="quote-card">
            <div class="quote-text">${escapedText}</div>
            <div class="quote-source">
                <div class="quote-meta">
                    <div class="quote-attribution"> <span class="author-name">${quote.author}</span></div>
                    <div class="quote-poem-title">"${quote.poemTitle}"</div>
                    <div class="quote-date">Saved ${date}</div>
                </div>
                <div class="quote-actions">
                    <button class="read-btn" onclick="readQuotePoem('${quote.poemId ? quote.poemId.replace(/'/g, "\\\\'") : ''}')" title="Read full poem">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:-1px;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Read Full Poem
                    </button>
                    <button onclick="copyQuote('${escapedId}')" title="Copy to clipboard">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:-1px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        Copy
                    </button>
                    <button class="delete-btn" onclick="deleteQuote('${escapedId}')" title="Delete quote">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:-1px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function handleQuotesSearch() {
    const query = document.getElementById('quotes-search').value;
    renderQuotes(query);
}

async function copyQuote(quoteId) {
    const quotes = await getQuotes();
    const quote = quotes.find(q => q.id === quoteId);
    if (!quote) return;

    const textToCopy = `"${quote.text}"\n ${quote.author}, "${quote.poemTitle}"`;
    await navigator.clipboard.writeText(textToCopy);
    showToast('Copied', 'Quote copied to clipboard with attribution.');
}

async function readQuotePoem(poemId) {
    if (!poemId) return;
    // Try my poems first, then library
    const myPoems = await getMyPoems();
    const myPoem = myPoems.find(p => p.id === poemId);
    if (myPoem) {
        openReader(poemId);
    } else {
        openReaderFromLibrary(poemId);
    }
}

async function startLearning(poemId) {
    const myPoems = await getMyPoems();
    let poem = myPoems.find(p => p.id === poemId);
    if (!poem) return;

    // Ensure poem is migrated to new format
    poem = migratePoem(poem);

    // Determine mode, starting stage, and stage 1 repetitions
    let mode = 'learn';
    let startStage = 1;
    let afterStage1Target = null;
    let stage1Reps = 3; // Default: first time through, read 3 times

    if (poem.isMemorized || poem.completedStage6) {
        // Already completed training - go straight to Stage 6, no warm-up
        mode = poem.isMemorized ? 'review' : 'recitation';
        startStage = 6;
        afterStage1Target = null;
        stage1Reps = 0;
    } else if (poem.lastStage > 1) {
        // Returning to continue learning - only 1 warm-up read
        afterStage1Target = poem.lastStage;
        stage1Reps = 1;
    }

    learningState = {
        poem,
        stage: startStage,
        repetition: 1,
        currentLine: 0,
        hintLevel: 0,
        hintsUsed: 0,
        lineHintLevels: {},
        mode,
        afterStage1Target,
        stage1Complete: false,
        stage1Reps, // Dynamic repetitions for Stage 1
        freeNavigation: false // Set to true after "Need More Practice"
    };

    document.getElementById('learning-container').classList.add('active');
    renderLearningStage();
    updateStageNav();
}

async function startPractice(poemId) {
    const myPoems = await getMyPoems();
    let poem = myPoems.find(p => p.id === poemId);
    if (!poem) return;

    // Ensure poem is migrated
    poem = migratePoem(poem);

    // Go straight to Stage 6 for practice/review
    learningState = {
        poem,
        stage: 6,
        repetition: 1,
        currentLine: 0,
        hintLevel: 0,
        hintsUsed: 0,
        lineHintLevels: {},
        mode: 'review',
        afterStage1Target: null,
        stage1Complete: true,
        stage1Reps: 0,
        freeNavigation: true
    };

    document.getElementById('learning-container').classList.add('active');
    renderLearningStage();
    updateStageNav();
}

async function exitLearning() {
    document.getElementById('learning-container').classList.remove('active');
    document.getElementById('next-button').style.display = 'block';
    document.getElementById('next-button').onclick = handleNext;
    await saveLearningProgress();
    renderMyPoems();
}

async function saveLearningProgress() {
    const myPoems = await getMyPoems();
    const idx = myPoems.findIndex(p => p.id === learningState.poem.id);
    if (idx === -1) return;

    // Ensure migrated
    let p = migratePoem(myPoems[idx]);

    // Update lastStage if we've progressed in learn mode
    if (learningState.mode === 'learn' && learningState.stage > p.lastStage) {
        p.lastStage = learningState.stage;
    }

    // Update current stage
    p.currentStage = learningState.stage;

    // Track hints used
    p.hintsUsed = (p.hintsUsed || 0) + learningState.hintsUsed;

    // Update legacy fields for backward compatibility
    p.stage = p.isMemorized ? 7 : Math.min(p.lastStage, 6);
    p.stageRepetition = learningState.repetition;

    myPoems[idx] = p;
    await saveOnePoem(myPoems[idx]);
}

function renderLearningStage() {
    const { poem, stage, repetition, mode, stage1Reps } = learningState;
    document.getElementById('learning-poem-title').textContent = poem.title;

    // Build stage label based on mode
    let stageLabel;
    if (mode === 'review') {
        stageLabel = stage === 1 ? 'Review - Warm-up Reading' : `Review - Stage ${stage}: ${STAGES[stage].name}`;
    } else if (mode === 'recitation') {
        stageLabel = stage === 1 ? 'Practice - Warm-up Reading' : `Practice - Stage ${stage}: ${STAGES[stage].name}`;
    } else {
        // Use dynamic stage1Reps for Stage 1
        const reps = (stage === 1 && stage1Reps !== undefined) ? stage1Reps : STAGES[stage].repetitions;
        stageLabel = `Stage ${stage}: ${STAGES[stage].name} (${repetition}/${reps})`;
    }
    document.getElementById('learning-stage-label').textContent = stageLabel;

    const body = document.getElementById('learning-body');
    const stanzas = getStanzas(poem);
    learningState.lineHintLevels = {};

    // Set button text
    let buttonText = 'Next';
    if (stage === 6) {
        buttonText = 'Complete Recitation';
    }
    document.getElementById('next-button').textContent = buttonText;
    document.getElementById('next-button').style.display = 'block';

    if (stage === 1) {
        body.innerHTML = `<h2 class="learning-poem-title">${poem.title}</h2><div id="poem-lines"></div><p class="learning-prompt">Read each line, then close your eyes and repeat it.</p>`;
        renderInitialReading(stanzas);
    } else if (stage <= 3) {
        body.innerHTML = `<h2 class="learning-poem-title">${poem.title}</h2><div class="hint-instructions">Click a line to reveal missing words one at a time.</div><div id="poem-lines"></div><p class="learning-prompt">Recite the line, filling in the blanks from memory.</p>`;
        renderBlanks(stanzas, stage);
    } else if (stage <= 5) {
        body.innerHTML = `<h2 class="learning-poem-title">${poem.title}</h2><div id="poem-lines"></div><p class="learning-prompt">Recite from the hint, click to reveal.</p>`;
        renderHints(stanzas, stage);
    } else {
        body.innerHTML = `<h2 class="learning-poem-title">${poem.title}</h2><div class="hint-instructions">Click any line for a hint: first letter -> first word -> last word -> full line</div><div id="poem-lines"></div><p class="learning-prompt">Recite the entire poem from memory.</p>`;
        renderDots(stanzas);
    }
}

function renderInitialReading(stanzas) {
    const container = document.getElementById('poem-lines');
    let idx = 0;
    stanzas.forEach(s => { const d = document.createElement('div'); d.className = 'learning-stanza'; s.forEach(l => { const ld = document.createElement('div'); ld.className = 'learning-line'; ld.textContent = l; ld.dataset.index = idx++; d.appendChild(ld); }); container.appendChild(d); });
    learningState.currentLine = 0;
    document.querySelectorAll('.learning-line')[0]?.classList.add('visible');
}

function renderBlanks(stanzas, stage) {
    const container = document.getElementById('poem-lines');
    let lineIdx = 0;

    // Helper to check if a word contains actual letters (not just punctuation/symbols)
    const isRealWord = (word) => /[a-zA-Z]/.test(word);

    stanzas.forEach(stanza => {
        const stanzaDiv = document.createElement('div');
        stanzaDiv.className = 'learning-stanza';

        stanza.forEach(line => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'learning-line visible';
            const words = line.replace(//g, '  ').split(/\s+/).filter(w => w.length > 0);

            // Determine which words are blanked (only real words, not punctuation)
            const blankedIndices = [];
            if (stage === 2) {
                // Stage 2: blank last real word and every 3rd real word
                let realWordCount = 0;
                words.forEach((w, i) => {
                    if (isRealWord(w)) {
                        realWordCount++;
                        if (realWordCount > 1 && realWordCount % 3 === 0) blankedIndices.push(i);
                    }
                });
                // Also blank last real word
                for (let i = words.length - 1; i >= 0; i--) {
                    if (isRealWord(words[i]) && !blankedIndices.includes(i)) {
                        blankedIndices.push(i);
                        break;
                    }
                }
            } else {
                // Stage 3: blank every other real word
                let realWordCount = 0;
                words.forEach((w, i) => {
                    if (isRealWord(w)) {
                        realWordCount++;
                        if (realWordCount % 2 === 0) blankedIndices.push(i);
                    }
                });
            }

            // Sort blanked indices so reveals go left-to-right
            blankedIndices.sort((a, b) => a - b);

            // Build HTML with sized blanks (escape quotes in data attributes)
            lineDiv.innerHTML = words.map((word, i) => {
                if (blankedIndices.includes(i)) {
                    const width = Math.max(word.length, 2);
                    const escaped = word.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<span class="blank" data-word="${escaped}" data-idx="${i}" style="width: ${width}ch;"></span>`;
                }
                return word;
            }).join(' ');

            // Store blanked words for progressive reveal
            lineDiv.dataset.blanks = JSON.stringify(blankedIndices);
            lineDiv.dataset.words = JSON.stringify(words);
            lineDiv.dataset.revealed = '[]';

            // Click line to reveal blanks one at a time
            lineDiv.onclick = function() {
                const blanks = JSON.parse(this.dataset.blanks);
                const wordsArr = JSON.parse(this.dataset.words);
                let revealed = JSON.parse(this.dataset.revealed);

                const nextBlank = blanks.find(idx => !revealed.includes(idx));

                if (nextBlank !== undefined) {
                    revealed.push(nextBlank);
                    this.dataset.revealed = JSON.stringify(revealed);

                    const blankSpan = this.querySelector(`.blank[data-idx="${nextBlank}"]`);
                    if (blankSpan) {
                        blankSpan.textContent = wordsArr[nextBlank];
                        blankSpan.classList.add('revealed');
                    }

                    learningState.hintsUsed++;

                    if (revealed.length === blanks.length) {
                        this.classList.add('revealed');
                    }
                }
            };

            stanzaDiv.appendChild(lineDiv);
            lineIdx++;
        });

        container.appendChild(stanzaDiv);
    });
}

function renderHints(stanzas, stage) {
    const container = document.getElementById('poem-lines');
    stanzas.forEach(s => { const d = document.createElement('div'); d.className = 'learning-stanza'; s.forEach(line => {
        const ld = document.createElement('div'); ld.className = 'learning-line visible';
        ld.innerHTML = stage === 4 ? line.replace(//g, '  ').split(/\s+/).filter(w => w.length > 0)[0] + '...' : line.charAt(0) + '...';
        ld.dataset.full = line;
        ld.onclick = () => { ld.innerHTML = line; ld.classList.add('revealed'); };
        d.appendChild(ld);
    }); container.appendChild(d); });
}

function renderDots(stanzas) {
    const container = document.getElementById('poem-lines');
    let idx = 0;
    stanzas.forEach(s => { const d = document.createElement('div'); d.className = 'learning-stanza'; s.forEach(line => {
        const ld = document.createElement('div'); ld.className = 'dot-line visible';
        ld.innerHTML = line.replace(//g, '  ').split(/\s+/).filter(w => w.length > 0).map(() => '<span class="word-dot"></span>').join('');
        ld.dataset.full = line; ld.dataset.index = idx;
        learningState.lineHintLevels[idx] = 0;
        ld.onclick = () => handleLineHint(ld, line, parseInt(ld.dataset.index));
        d.appendChild(ld); idx++;
    }); container.appendChild(d); });
}

function handleLineHint(ld, line, idx) {
    const lvl = learningState.lineHintLevels[idx] || 0;
    const words = line.replace(//g, '  ').split(/\s+/).filter(w => w.length > 0);
    learningState.lineHintLevels[idx] = lvl + 1;
    if (lvl < 3) learningState.hintsUsed++;

    // Helper to check if a word contains actual letters
    const isRealWord = (word) => /[a-zA-Z]/.test(word);

    // Find first and last real words
    const firstWord = words.find(w => isRealWord(w)) || words[0];
    let lastWord = words[words.length - 1];
    for (let i = words.length - 1; i >= 0; i--) {
        if (isRealWord(words[i])) {
            lastWord = words[i];
            break;
        }
    }

    if (lvl === 0) ld.innerHTML = `<span class="hint-text">${line.charAt(0)}...</span>`;
    else if (lvl === 1) ld.innerHTML = `<span class="hint-text">${firstWord}...</span>`;
    else if (lvl === 2 && words.length > 1) ld.innerHTML = `<span class="hint-text">${firstWord} ... ${lastWord}</span>`;
    else { ld.innerHTML = `<span class="full-line">${line}</span>`; ld.classList.add('revealed'); }
}

function updateStageNav() {
    const { stage, mode, poem, freeNavigation } = learningState;
    const prevBtn = document.getElementById('prev-stage-btn');
    const nextBtn = document.getElementById('next-stage-btn');

    // Previous stage - can go back if stage > 1
    prevBtn.disabled = stage <= 1;

    // Next/skip stage - can skip forward up to lastStage (in learn mode) or stage 6 (in review/recitation/freeNavigation mode)
    const maxStage = (mode === 'learn' && !freeNavigation) ? (poem.lastStage || 1) : 6;
    nextBtn.disabled = stage >= maxStage;
}

function navigateStage(direction) {
    const { stage, mode, poem, freeNavigation } = learningState;

    const newStage = stage + direction;
    if (newStage < 1 || newStage > 6) return;

    // In learn mode without free navigation, can only go forward to stages already reached
    if (mode === 'learn' && !freeNavigation && direction > 0 && newStage > poem.lastStage) return;

    learningState.stage = newStage;
    learningState.repetition = 1;
    learningState.currentLine = 0;

    renderLearningStage();
    updateStageNav();
    requestAnimationFrame(() => {
        document.getElementById('learning-container').scrollTo({ top: 0, behavior: 'instant' });
    });
}

async function handleNext() {
    const { stage, repetition, mode, afterStage1Target, stage1Reps } = learningState;

    // Handle Stage 1 line-by-line reveal
    if (stage === 1) {
        const lines = document.querySelectorAll('.learning-line');
        learningState.currentLine++;
        if (learningState.currentLine < lines.length) {
            lines[learningState.currentLine].classList.add('visible');
            // Auto-scroll to the newly revealed line
            lines[learningState.currentLine].scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        // Use dynamic stage1Reps (3 for first time, 1 for returning)
        const repsNeeded = stage1Reps !== undefined ? stage1Reps : STAGES[stage].repetitions;
        if (repetition < repsNeeded) {
            learningState.repetition++;
            learningState.currentLine = 0;
            renderLearningStage();
            // Scroll back to top for the new reading
            requestAnimationFrame(() => {
                document.getElementById('learning-container').scrollTo({ top: 0, behavior: 'instant' });
            });
            return;
        }

        // Stage 1 complete - jump to afterStage1Target if set
        learningState.stage1Complete = true;
        if (afterStage1Target && afterStage1Target > 1) {
            learningState.stage = afterStage1Target;
            learningState.repetition = 1;
            renderLearningStage();
            updateStageNav();
            requestAnimationFrame(() => {
                document.getElementById('learning-container').scrollTo({ top: 0, behavior: 'instant' });
            });
            return;
        }
    }

    // Handle Stage 6 completion - show recitation result buttons
    if (stage === 6) {
        showRecitationComplete();
        return;
    }

    // Handle repetitions within a stage
    if (stage >= 1 && stage <= 5 && repetition < STAGES[stage].repetitions) {
        learningState.repetition++;
        renderLearningStage();
        requestAnimationFrame(() => {
            document.getElementById('learning-container').scrollTo({ top: 0, behavior: 'instant' });
        });
        return;
    }

    // Advance to next stage
    if (stage < 6) {
        learningState.stage++;
        learningState.repetition = 1;

        // Update lastStage if progressing in learn mode
        if (mode === 'learn' && learningState.stage > learningState.poem.lastStage) {
            learningState.poem.lastStage = learningState.stage;
        }

        renderLearningStage();
        updateStageNav();
        requestAnimationFrame(() => {
            document.getElementById('learning-container').scrollTo({ top: 0, behavior: 'instant' });
        });
    }
}

function showCompletion(msg) {
    document.getElementById('learning-body').innerHTML = `<div class="practice-summary"><h3>${msg}</h3><p style="color:var(--text-muted);margin-top:20px;">Keep practicing!</p><button class="btn btn-secondary" style="margin-top:30px;" onclick="exitLearning(); switchTab('my-poems');">Exit Learning Module</button></div>`;
    document.getElementById('next-button').style.display = 'none';
    document.getElementById('prev-stage-btn').disabled = true;
    document.getElementById('next-stage-btn').disabled = true;
}

function showRecitationComplete() {
    const { poem, mode } = learningState;
    const p = migratePoem(poem);

    let progressText, title;
    if (p.isMemorized) {
        // Review mode
        const reviewCount = p.successfulReviews || 0;
        progressText = `${reviewCount} successful reviews`;
        title = 'Review Complete!';
    } else {
        // Recitation practice mode
        const recitationCount = p.successfulRecitations || 0;
        progressText = `${recitationCount}/3 successful recitations`;
        title = 'Recitation Complete!';
    }

    document.getElementById('learning-body').innerHTML = `
        <div class="recitation-complete">
            <h3>${title}</h3>
            <p class="recitation-progress">${progressText}</p>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">How did it go?</p>
            <div class="recitation-buttons">
                <button class="btn btn-secondary" onclick="handleRecitationResult('needsPractice')">
                    Need More Practice
                </button>
                <button class="btn btn-primary" onclick="handleRecitationResult('easy')">
                    Easy - I knew it well
                </button>
            </div>
        </div>`;

    document.getElementById('next-button').style.display = 'none';
    document.getElementById('prev-stage-btn').disabled = true;
    document.getElementById('next-stage-btn').disabled = true;
}

async function handleRecitationResult(result) {
    const { poem, mode } = learningState;
    const myPoems = await getMyPoems();
    const idx = myPoems.findIndex(p => p.id === poem.id);
    if (idx === -1) return;

    // Ensure migrated
    let p = migratePoem(myPoems[idx]);

    if (result === 'easy') {
        // Record the review/recitation result
        p.reviewHistory = p.reviewHistory || [];
        p.reviewHistory.push({ date: Date.now(), result: 'easy' });
        p.lastReviewDate = Date.now();

        if (p.isMemorized) {
            // Already memorized - increment review count
            p.successfulReviews = (p.successfulReviews || 0) + 1;
            p.nextReviewDate = calculateNextReviewDate(p.successfulReviews);

            // Update legacy field
            p.lastPracticed = Date.now();

            myPoems[idx] = p;
            await saveOnePoem(myPoems[idx]);
            await checkAchievements();
            showCompletion(`Review complete! Next review in ${Math.ceil((p.nextReviewDate - Date.now()) / 86400000)} days.`);
        } else {
            // Working toward memorization
            p.successfulRecitations = (p.successfulRecitations || 0) + 1;
            p.completedStage6 = true;

            if (p.successfulRecitations >= 3) {
                // Achieved memorization!
                p.isMemorized = true;
                p.memorizedDate = Date.now();
                p.successfulReviews = 0;
                p.nextReviewDate = calculateNextReviewDate(0);

                // Update legacy field
                p.stage = 8;
                p.lastPracticed = Date.now();

                myPoems[idx] = p;
                await saveOnePoem(myPoems[idx]);
                await checkAchievements();
                showCompletion("Congratulations! You've memorized this poem!");
            } else {
                myPoems[idx] = p;
                await saveOnePoem(myPoems[idx]);
                showCompletion(`Great work! ${p.successfulRecitations}/3 successful recitations.`);
            }
        }
    } else {
        // Need more practice - go to Stage 2 with free navigation
        p.reviewHistory = p.reviewHistory || [];
        p.reviewHistory.push({ date: Date.now(), result: 'needsPractice' });

        myPoems[idx] = p;
        await saveOnePoem(myPoems[idx]);

        // Enable free navigation and jump to Stage 2
        learningState.freeNavigation = true;
        learningState.stage = 2;
        learningState.repetition = 1;
        learningState.currentLine = 0;

        document.getElementById('next-button').style.display = 'block';
        renderLearningStage();
        updateStageNav();
    }
}

// =====================================
// AUTH UI FUNCTIONS
// =====================================

function openAuthModal(tab = 'login') {
    // Check for local poems to show sync notice
    const localPoems = getLocalPoems();
    document.getElementById('sync-notice').style.display = localPoems.length > 0 ? 'block' : 'none';

    switchAuthTab(tab);
    document.getElementById('auth-modal').classList.add('active');
}

function openLegalModal(type) {
    if (type === 'privacy') {
        document.getElementById('privacy-modal').classList.add('active');
    } else if (type === 'terms') {
        document.getElementById('terms-modal').classList.add('active');
    } else if (type === 'support') {
        document.getElementById('support-modal').classList.add('active');
    }
}

function switchAuthTab(tab) {
    // Hide all forms
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));

    // Clear messages
    document.getElementById('auth-error').classList.remove('visible');
    document.getElementById('auth-success').classList.remove('visible');

    // Show selected form
    if (tab === 'login') {
        document.getElementById('login-form').classList.add('active');
        document.querySelector('.auth-tab:first-child').classList.add('active');
    } else if (tab === 'signup') {
        document.getElementById('signup-form').classList.add('active');
        document.querySelector('.auth-tab:last-child').classList.add('active');
    } else if (tab === 'forgot') {
        document.getElementById('forgot-form').classList.add('active');
    }
}

function showForgotPassword() {
    switchAuthTab('forgot');
}

function showAuthError(message) {
    const el = document.getElementById('auth-error');
    el.textContent = message;
    el.classList.add('visible');
    document.getElementById('auth-success').classList.remove('visible');
}

function showAuthSuccess(message) {
    const el = document.getElementById('auth-success');
    el.textContent = message;
    el.classList.add('visible');
    document.getElementById('auth-error').classList.remove('visible');
}

async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    if (!email || !password) {
        showAuthError('Please enter email and password');
        return;
    }

    try {
        if (typeof signIn !== 'function') {
            showAuthError('Supabase not configured. Please set up your Supabase project.');
            return;
        }
        await signIn(email, password);
        // Auth state change will handle the rest
    } catch (error) {
        showAuthError(error.message || 'Login failed. Please check your credentials.');
    }
}

async function handleSignup(e) {
    e.preventDefault();
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const confirm = document.getElementById('signup-confirm').value;
    const termsAccepted = document.getElementById('signup-terms').checked;

    if (!email || !password) {
        showAuthError('Please enter email and password');
        return;
    }

    if (password.length < 6) {
        showAuthError('Password must be at least 6 characters');
        return;
    }

    if (password !== confirm) {
        showAuthError('Passwords do not match');
        return;
    }

    if (!termsAccepted) {
        showAuthError('You must agree to the Privacy Policy and Terms of Service to create an account');
        return;
    }

    try {
        if (typeof signUp !== 'function') {
            showAuthError('Supabase not configured. Please set up your Supabase project.');
            return;
        }
        await signUp(email, password);
        showAuthSuccess('Account created! Check your email to confirm your account.');
        document.getElementById('signup-form').reset();
    } catch (error) {
        showAuthError(error.message || 'Signup failed. Please try again.');
    }
}

async function handleForgotPassword(e) {
    e.preventDefault();
    const email = document.getElementById('forgot-email').value.trim();

    if (!email) {
        showAuthError('Please enter your email');
        return;
    }

    try {
        if (typeof resetPassword !== 'function') {
            showAuthError('Supabase not configured. Please set up your Supabase project.');
            return;
        }
        await resetPassword(email);
        showAuthSuccess('Password reset link sent! Check your email.');
        document.getElementById('forgot-form').reset();
    } catch (error) {
        showAuthError(error.message || 'Could not send reset link. Please try again.');
    }
}

async function handleLogout() {
    try {
        if (typeof signOut === 'function') {
            await signOut();
        }
        currentUser = null;
        userPoemsCache = null;
        updateAuthUI();
        renderMyPoems();
    } catch (error) {
        console.error('Logout error:', error);
    }
}

function openDeleteAccountModal() {
    openModal('delete-warning-modal');
}

function openDeleteConfirmModal() {
    document.getElementById('delete-confirm-input').value = '';
    document.getElementById('delete-account-error').classList.remove('visible');
    openModal('delete-account-modal');
}

function openChangePasswordModal() {
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').classList.remove('visible');
    document.getElementById('change-password-success').classList.remove('visible');
    document.getElementById('change-password-modal').classList.add('active');
}

async function handleChangePassword(e) {
    e.preventDefault();
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    const errorEl = document.getElementById('change-password-error');
    const successEl = document.getElementById('change-password-success');

    errorEl.classList.remove('visible');
    successEl.classList.remove('visible');

    if (newPassword.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters';
        errorEl.classList.add('visible');
        return;
    }

    if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.classList.add('visible');
        return;
    }

    try {
        if (typeof updatePassword !== 'function') {
            errorEl.textContent = 'Password update not available';
            errorEl.classList.add('visible');
            return;
        }

        await updatePassword(newPassword);
        successEl.textContent = 'Password updated successfully!';
        successEl.classList.add('visible');
        document.getElementById('change-password-form').reset();

        // Close modal after a short delay
        setTimeout(() => {
            closeModal('change-password-modal');
        }, 1500);
    } catch (error) {
        errorEl.textContent = error.message || 'Failed to update password. Please try again.';
        errorEl.classList.add('visible');
    }
}

async function confirmDeleteAccount() {
    const confirmInput = document.getElementById('delete-confirm-input').value.trim();
    const errorEl = document.getElementById('delete-account-error');

    if (confirmInput !== 'DELETE') {
        errorEl.textContent = 'Please type DELETE to confirm account deletion';
        errorEl.classList.add('visible');
        return;
    }

    if (!currentUser) {
        errorEl.textContent = 'No user logged in';
        errorEl.classList.add('visible');
        return;
    }

    try {
        // Delete all user data from Supabase
        if (typeof deleteUserAccount === 'function') {
            await deleteUserAccount(currentUser.id);
        }

        // Clear local data
        localStorage.removeItem('mnemosyne_my_poems');
        localStorage.removeItem('mnemosyne_achievements');
        localStorage.removeItem('mnemosyne_quotes');

        // Sign out
        if (typeof signOut === 'function') {
            await signOut();
        }

        currentUser = null;
        userPoemsCache = null;

        closeModal('delete-account-modal');
        updateAuthUI();
        renderMyPoems();
        showToast('Account Deleted', 'Your account and all data have been permanently deleted.');
    } catch (error) {
        errorEl.textContent = error.message || 'Failed to delete account. Please try again.';
        errorEl.classList.add('visible');
    }
}

function updateAuthUI() {
    const authButtons = document.getElementById('auth-buttons');
    if (currentUser) {
        authButtons.innerHTML = `
            <button class="auth-btn auth-btn-primary" onclick="openSettingsModal()">Settings</button>
            <button class="auth-btn auth-btn-secondary" onclick="openModal('logout-confirm-modal')">Log Out</button>`;
    } else {
        authButtons.innerHTML = `
            <button class="auth-btn auth-btn-secondary" onclick="openAuthModal('login')">Log In</button>
            <button class="auth-btn auth-btn-primary" onclick="openAuthModal('signup')">Sign Up</button>`;
    }
}

function openSettingsModal() {
    document.getElementById('settings-account-email').textContent = currentUser?.email || '';
    var manageBtn = document.getElementById('settings-manage-sub-btn');
    if (manageBtn) {
        manageBtn.style.display = 'none';
    }
    openModal('settings-modal');
}

function manageSubscription() {
    openModal('manage-sub-modal');
}

async function executeManageSubscription() {
    if (typeof showManageSubscriptions === 'function') {
        await showManageSubscriptions();
    }
}

async function handleAuthStateChange(event, session) {
    if (event === 'SIGNED_IN' && session?.user) {
        currentUser = session.user;
        userPoemsCache = null;
        userQuotesCache = null;

        // One-time migration of local poems to Supabase (only if never migrated before)
        const poemsMigrated = localStorage.getItem('mnemosyne_poems_migrated_' + currentUser.id);
        if (!poemsMigrated) {
            const localPoems = getLocalPoems();
            if (localPoems.length > 0 && typeof syncAllPoems === 'function') {
                try {
                    await syncAllPoems(currentUser.id, localPoems);
                } catch (e) {
                    console.error('Error syncing local poems:', e);
                }
            }
            localStorage.setItem('mnemosyne_poems_migrated_' + currentUser.id, 'true');
        }

        // One-time migration of local quotes to Supabase
        const quotesMigrated = localStorage.getItem('mnemosyne_quotes_migrated_' + currentUser.id);
        if (!quotesMigrated) {
            const localQuotes = getLocalQuotes();
            if (localQuotes.length > 0 && typeof syncAllQuotes === 'function') {
                try {
                    await syncAllQuotes(currentUser.id, localQuotes);
                } catch (e) {
                    console.error('Error syncing local quotes:', e);
                }
            }
            localStorage.setItem('mnemosyne_quotes_migrated_' + currentUser.id, 'true');
        }

        // When online, Supabase is source of truth  sync it down to localStorage backup
        const online = typeof isAppOnline === 'function' ? isAppOnline() : navigator.onLine;
        if (online && typeof fetchUserPoems === 'function') {
            const supabasePoems = await fetchUserPoems(currentUser.id);
            if (supabasePoems.length > 0) {
                userPoemsCache = supabasePoems;
                saveLocalPoems(supabasePoems);
            }
        }

        closeModal('auth-modal');
        updateAuthUI();
        renderMyPoems();
    } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        userPoemsCache = null;
        userQuotesCache = null;

        updateAuthUI();
        renderMyPoems();
    }
}

async function initAuth() {
    // Initialize Supabase if available
    if (typeof initSupabase === 'function' && typeof isSupabaseConfigured === 'function') {
        if (isSupabaseConfigured()) {
            initSupabase();

            // Set up auth state listener
            if (typeof onAuthStateChange === 'function') {
                onAuthStateChange(handleAuthStateChange);
            }

            // Check current user
            if (typeof getCurrentUser === 'function') {
                currentUser = await getCurrentUser();

                updateAuthUI();
            }
        }
    }
}


async function init() {
    applyTheme();

    // Initialize offline sync for Capacitor app
    if (typeof initOfflineSync === 'function') {
        initOfflineSync();
    }

    await initAuth();
    loadLibrary();
    checkHashRoute();
}

document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Capacitor Core (injected natively in mobile builds) -->

    <!-- Offline Sync Manager -->
    <script src="offline-sync.js"></script>

    <!-- Initialize Capacitor plugins when available -->
    <script>
        // Capacitor-specific initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Check if running in Capacitor
            if (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform()) {
                console.log('Running in Capacitor native app');
                document.body.classList.add('platform-mobile');

                // Set status bar height as CSS variable for header padding
                var isIOS = window.Capacitor.getPlatform && window.Capacitor.getPlatform() === 'ios';
                var statusBarHeight = isIOS ? 47 : 24; // iOS notch area vs Android status bar
                try {
                    var StatusBar = window.Capacitor.Plugins.StatusBar;
                    if (StatusBar) {
                        // Apply initial theme-based status bar style
                        var isDarkMode = getSettings().darkMode;
                        StatusBar.setStyle({ style: isDarkMode ? 'DARK' : 'LIGHT' });
                    }
                } catch(e) { console.log('StatusBar height detection failed', e); }
                document.documentElement.style.setProperty('--status-bar-height', statusBarHeight + 'px');

                // Handle back button (Android only, no-op on iOS)
                document.addEventListener('backbutton', function(e) {
                    const learningContainer = document.querySelector('.learning-container.active');
                    const modal = document.querySelector('.modal-overlay.active');

                    if (learningContainer) {
                        e.preventDefault();
                        exitLearning();
                    } else if (modal) {
                        e.preventDefault();
                        closeModal();
                    }
                }, false);
            }
        });
    </script>
</body>
</html>
